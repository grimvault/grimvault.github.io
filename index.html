<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grimoire - The Void</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/Mk6zfrV1/cropped-circle-image-11.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Diff Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Inter:wght@300;400;500;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&display=swap');
		@import url('https://fonts.googleapis.com/css2?family=Skranji&display=swap');

        :root {
            --blood-red: #8a0303;
            --blood-bright: #ff0f0f;
            --void: #050505;
            --surface: #0a0a0a;
            --border-dim: rgba(255,255,255,0.08);
            --spectral: #a3bffa; 
            --decay: #4a5d48;
            --toxin: #1a472a;
            --toxin-bright: #2dce89;
        }

        /* --- RESET & BASE --- */
        * { scrollbar-width: thin; scrollbar-color: var(--blood-red) var(--void); }
        
        html, body {
            background-color: var(--void);
            color: #e5e5e5;
            margin: 0;
            width: 100%;
            height: 100%;
            /* Fix for Mobile Overlay Scroll/Shift */
            overscroll-behavior: none; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
        }

        /* Fix: Lock body on mobile when modal is open to prevent background scroll */
        body.modal-open { 
            overflow: hidden; 
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        input, textarea, button { outline: none; appearance: none; -webkit-appearance: none; font-family: inherit; }
        img { border-radius: 4px; }

		.font-horror { 
			font-family: 'Skranji', cursive; 
			letter-spacing: 0.1em; 
		}
		.font-story { 
			font-family: 'Merriweather', serif; 
		}

		/* --- CREATOR ANIMATION --- */
		@keyframes flowRight {
			0% { background-position: 0% 50%; }
			100% { background-position: 200% 50%; }
		}

		.text-creator {
			background: linear-gradient(
				90deg,
				#5c0000,  /* very dark red */
				#8a0000,  /* dark red */
				#cc0000,  /* deep red */
				#ff1a1a,  /* bright red */
				#5c0000   /* very dark red again */
			);
			background-size: 200% 100%;
			color: transparent;
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			animation: flowRight 3s linear infinite;
			font-weight: 900;
			display: inline-block;
			letter-spacing: 0.5px;
		}
		
		.vignette {
		  position: fixed;
		  top: 0;
		  left: 0;
		  width: 100vw; /* use viewport width explicitly */
		  height: calc(var(--vh, 1vh) * 100); /* use JS-set --vh for stable height on mobile */
		  pointer-events: none;
		  z-index: 40;
		  background: radial-gradient(circle at center,
			transparent 0%,
			rgba(5,5,5,0.4) 60%,
			rgba(0,0,0,0.95) 100%);
		  /* Force compositing / hardware acceleration so mobile won't treat it as part of scroll layer */
		  transform: translateZ(0);
		  will-change: transform;
		  -webkit-transform: translate3d(0,0,0);
		  backface-visibility: hidden;
		  -webkit-backface-visibility: hidden;
		  touch-action: none;
		}

        /* --- UI COMPONENTS --- */
        .glass {
            background: rgba(12, 12, 12, 0.9);
            backdrop-filter: blur(16px);
            border: 1px solid var(--border-dim);
            box-shadow: 0 4px 40px rgba(0, 0, 0, 0.6);
        }
        
        .glass-thread {
            background: #050505;
            border: 1px solid #222;
            box-shadow: 0 0 60px rgba(0,0,0,1);
        }

        .input-void {
            background: rgba(0,0,0,0.4);
            border: 1px solid #333;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            transition: border-color 0.3s ease;
            width: 100%;
        }
        .input-void:focus { border-color: var(--blood-red); box-shadow: 0 0 15px rgba(138, 3, 3, 0.1); }
        .input-void:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Validation Feedback States */
        .input-error { border-color: #8a0303 !important; }
        .input-success { border-color: #2dce89 !important; }
        .text-error { color: #ff0f0f; font-size: 0.75rem; margin-top: 4px; }
        .text-success { color: #2dce89; font-size: 0.75rem; margin-top: 4px; }

        .spin-edit-container {
            display: flex;
            align-items: center;
            border: 1px solid rgba(45, 206, 137, 0.2);
            border-radius: 6px;
            background: linear-gradient(180deg, rgba(0,20,5,0.6) 0%, rgba(0,10,0,0.8) 100%);
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: border-color 0.2s;
        }
        .spin-edit-container:hover { border-color: rgba(45, 206, 137, 0.4); }
        .spin-btn {
            background: transparent;
            color: #4a7a5e;
            width: 28px;
            height: 36px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.8em;
        }
        .spin-btn:hover { background: rgba(45, 206, 137, 0.1); color: #2dce89; }
        .spin-input {
            background: transparent;
            border-left: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
            color: #2dce89;
            text-align: center;
            width: 50px;
            height: 36px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 0.9em;
        }
        .spin-input:focus { outline: none; background: rgba(45, 206, 137, 0.05); }
        .spin-input::-webkit-outer-spin-button,
        .spin-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .spin-input[type=number] { -moz-appearance: textfield; }

        .custom-select { position: relative; cursor: pointer; user-select: none; }
        .select-selected {
            background: rgba(0,0,0,0.4); border: 1px solid #333; color: #888;
            padding: 12px 16px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
        }
        .select-selected:after { 
            content: '\f078'; 
            font-family: 'Font Awesome 6 Free'; 
            font-weight: 900; 
            transition: transform 0.3s;
            font-size: 0.7em;
            color: #555;
            margin-left: 8px;
        }
        .select-selected.select-active { border-color: var(--blood-red); color: white; }
        .select-selected.select-active:after { transform: rotate(180deg); color: var(--blood-red); }
        
        .select-items {
            position: absolute; background: #0a0a0a; border: 1px solid #333; top: 100%; left: 0; right: 0; z-index: 999;
            display: none; border-radius: 4px; overflow: hidden; margin-top: 4px; max-height: 240px; overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.9);
        }
        .select-items div { padding: 8px 12px; transition: 0.2s; color: #ccc; font-size: 0.85rem; }
        .select-items div:hover { background: var(--blood-red); color: white; }
        .select-show { display: block; }

        .btn-main {
            background: linear-gradient(180deg, #2a0505 0%, #1a0000 100%);
            border: 1px solid var(--blood-red); color: var(--blood-red);
            padding: 12px 24px; border-radius: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn-main:hover { background: var(--blood-red); color: white; box-shadow: 0 0 25px rgba(138, 3, 3, 0.5); }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .btn-secondary {
            background: transparent; border: 1px solid #333; color: #888;
            padding: 8px 16px; border-radius: 4px; transition: 0.3s;
        }
        .btn-secondary:hover { border-color: #666; color: white; background: rgba(255,255,255,0.05); }

        .btn-tip-green {
            background: rgba(0, 20, 0, 0.4);
            border: 1px solid #2dce89;
            color: #2dce89;
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 10px rgba(45, 206, 137, 0.1);
        }
        .btn-tip-green:hover {
            background: #2dce89;
            color: #050505;
            box-shadow: 0 0 20px rgba(45, 206, 137, 0.5);
        }
        
        .coven-post-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .coven-post-card:hover {
            transform: scale(1.03);
            box-shadow: 0 10px 40px -10px rgba(138, 3, 3, 0.3);
        }


        .story-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; }
        .story-card:hover { transform: translateY(-4px); border-color: var(--blood-red); box-shadow: 0 10px 40px -10px rgba(138, 3, 3, 0.2); }

        /* Smoother Thread Card Animation */
        .thread-card {
            border-left: 2px solid #333;
            border-right: 1px solid transparent;
            border-top: 1px solid transparent;
            border-bottom: 1px solid transparent;
            background: rgba(10,10,10,0.8);
            position: relative;
            transition: transform 0.3s ease-out, border-color 0.3s ease, background-color 0.3s ease;
        }
        .thread-card:hover { 
            border-left-color: var(--blood-red); 
            background-color: rgba(20, 10, 10, 0.9);
            transform: translateX(4px);
        }

        .stats-card {
            background: linear-gradient(180deg, rgba(5,5,5,0.4) 0%, rgba(0,0,0,0.6) 100%);
            border: 1px solid rgba(255,255,255,0.05);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        .stats-card:hover {
            border-color: var(--blood-red);
            background: rgba(138, 3, 3, 0.1);
        }
        .stats-card.clickable { cursor: pointer; }


        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease forwards; }

        @keyframes pulse-slow {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 8s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* --- RICH TEXT EDITOR & READER STYLES --- */
        #editor-content:empty:before {
            content: "It began in the silence...";
            color: #4a4a4a;
            font-style: italic;
            position: absolute;
            pointer-events: none;
        }
        
        #editor-content ul, #reader-body ul, #diff-original ul, #diff-new ul { list-style-type: disc; padding-left: 20px; margin: 10px 0; }
        #editor-content ol, #reader-body ol, #diff-original ol, #diff-new ol { list-style-type: decimal; padding-left: 20px; margin: 10px 0; }
        #reader-body blockquote, #diff-original blockquote, #diff-new blockquote { border-left: 3px solid var(--blood-red); padding-left: 1rem; font-style: italic; color: #888; }
        #editor-content img, #reader-body img, #diff-original img, #diff-new img { max-width: 100%; height: auto; margin: 1rem 0; display: block; }

		.toolbar-layer { 
			position: relative; 
			z-index: 50; 
			overflow: visible; /* Changed from overflow-x: auto */
			white-space: normal; /* Changed from nowrap */
			flex-wrap: wrap; /* Ensures buttons wrap on mobile instead of scrolling */
		}
        
        /* Horizontal Scroll */
        .scroller {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        .scroller::-webkit-scrollbar { display: none; }
        
        @keyframes ping-pong-scroll {
            0% { transform: translateX(0); }
            50% { transform: translateX(calc(-100% + 40px)); } /* Adjust based on card width and gap */
            100% { transform: translateX(0); }
        }

        .scrolling-enabled .scrolling-wrapper {
            animation: ping-pong-scroll 100s linear infinite alternate;
        }
        
        /* Tabs */
        .profile-tab {
            padding-bottom: 0.5rem;
            color: #888;
            font-weight: 700;
            font-size: 0.9rem;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .profile-tab:hover { color: white; }
        .profile-tab.active {
            color: var(--blood-red);
            border-color: var(--blood-red);
            text-shadow: 0 0 10px rgba(138, 3, 3, 0.5);
        }

        /* Cropper.js Modal Styling -- IMPROVED */
        #cropper-modal .glass {
            border-color: var(--blood-red);
            background: rgba(5,0,0,0.9);
        }
        #cropper-modal .cropper-container { margin: auto; }
        #cropper-modal .cropper-view-box,
        #cropper-modal .cropper-face { border-radius: 50%; box-shadow: 0 0 0 100vmax rgba(0,0,0,0.5); }
        #cropper-modal .cropper-modal { background: none; }
        .cropper-bg {
            background-image: none; /* Hide default checkerboard */
        }
        #cropper-image-container {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 8px;
            border: 1px solid var(--border-dim);
            margin-bottom: 1.5rem;
        }

        /* --- CUSTOM TOOLTIP --- */
        #custom-tooltip {
            position: fixed;
            z-index: 10000;
            background: rgba(5, 5, 5, 0.95);
            border: 1px solid var(--blood-red);
            color: #e5e5e5;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.05em;
            pointer-events: none; /* Mouse passes through it */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.9);
            white-space: normal;
            max-width: 250px;
            backdrop-filter: blur(4px);
        }
        #custom-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 640px) {
            .view-section { padding-bottom: 120px; } /* Added Extra padding for mobile */
            .font-horror { letter-spacing: 0.05em; }
        }
		
		(function() {
		  function setVh() {
			// set --vh to 1% of the *current* innerHeight so height calc is stable
			document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
		  }

		  // initial
		  setVh();

		  // update on resize/orientation changes, and visualViewport if available (more accurate on mobile)
		  window.addEventListener('resize', setVh);
		  window.addEventListener('orientationchange', setVh);

		  if (window.visualViewport) {
			window.visualViewport.addEventListener('resize', setVh);
			window.visualViewport.addEventListener('scroll', setVh);
		  }

		  // Optional: ensure the vignette is always re-painted after touchend (works around odd Android edge-cases)
		  window.addEventListener('touchend', () => {
			const el = document.querySelector('.vignette');
			if (!el) return;
			// quick no-op reflow -> force repaint
			el.style.display = 'none';
			requestAnimationFrame(() => {
			  el.style.display = '';
			});
		  }, {passive: true});
		})();
		
		/* Subtle animated gradient text */
		.grimoire-text {
			background: linear-gradient(90deg, #8b0000, #b22222, #8b0000);
			background-size: 200% auto;
			color: transparent;
			-webkit-background-clip: text;
			background-clip: text;
			animation: gradientFlow 4s linear infinite;
		}

		/* --- GHOST ANIMATION (CALM & SUBTLE) --- */
		@keyframes ghost-float {
			/* Start: Center */
			0% {
				transform: translate(0, 0) rotate(0deg);
			}
			/* Drift gently Up and Right */
			25% {
				transform: translate(2px, -3px) rotate(2deg);
			}
			/* Drift gently Down and Left */
			50% {
				transform: translate(-2px, 1px) rotate(-1deg);
			}
			/* Float slightly Up and Left */
			75% {
				transform: translate(-1px, -4px) rotate(-2deg);
			}
			/* Return to Center smoothly */
			100% {
				transform: translate(0, 0) rotate(0deg);
			}
		}

		.ghost-icon {
			display: inline-block;
			/* 
			   6s duration + small movements = very slow velocity.
			   It feels like it's barely moving, just hovering alive.
			*/
			animation: ghost-float 7s ease-in-out infinite;
			will-change: transform;
		}

		/* Text gradient flow */
		@keyframes gradientFlow {
			0% { background-position: 0% 50%; }
			100% { background-position: 200% 50%; }
		}
    </style>
</head>
<body>

    <!-- FX -->
    <div class="vignette"></div>

    <!-- CUSTOM TOOLTIP CONTAINER -->
    <div id="custom-tooltip"></div>

    <!-- GLOBAL LOADER -->
    <div id="global-loader" class="fixed inset-0 z-[100] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
        <h1 class="font-horror text-7xl text-red-700 animate-pulse mb-6 tracking-widest">Grimoire</h1>
        <div class="w-16 h-16 border-t-2 border-r-2 border-red-800 rounded-full animate-spin"></div>
    </div>

    <!-- NOTIFICATION MODAL -->
    <div id="modal-alert" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[90%] max-w-sm p-8 rounded-lg text-center border border-red-900/40">
            <h3 id="alert-title" class="font-horror text-2xl text-red-500 mb-2">Notice</h3>
            <p id="alert-msg" class="text-gray-400 mb-8 text-sm leading-relaxed">Message</p>
            <div id="alert-actions">
                <button onclick="ui.closeAlert()" class="btn-main w-full">Acknowledged</button>
            </div>
        </div>
    </div>

    <!-- CONFIRMATION MODAL (NEW) -->
    <div id="modal-confirm" class="fixed inset-0 z-[115] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[90%] max-w-sm p-8 rounded-lg text-center border border-yellow-900/40 shadow-[0_0_30px_rgba(255,165,0,0.1)]">
            <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-4"></i>
            <h3 id="confirm-title" class="font-horror text-2xl text-yellow-500 mb-2">Confirm</h3>
            <p id="confirm-msg" class="text-gray-400 mb-8 text-sm leading-relaxed">Are you sure?</p>
            <div class="flex gap-3">
                <button id="btn-confirm-cancel" class="btn-secondary w-full">Cancel</button>
                <button id="btn-confirm-yes" class="btn-main w-full border-yellow-700 text-yellow-500 hover:bg-yellow-900/20">Proceed</button>
            </div>
        </div>
    </div>

    <!-- COVEN MEMBERS MODAL -->
    <div id="modal-coven-members" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-md p-6 rounded-lg border border-white/10 relative">
            <button onclick="ui.closeModal('modal-coven-members')" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="font-horror text-2xl text-red-500 mb-4">Coven Coveneers</h3>
            <div id="coven-members-list" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                <!-- Member list populated by JS -->
            </div>
        </div>
    </div>
    
    <!-- FOLLOW LIST MODAL -->
    <div id="modal-follow-list" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-sm p-6 rounded-lg border border-white/10 relative">
            <button onclick="ui.closeModal('modal-follow-list')" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 id="follow-list-title" class="font-horror text-2xl text-red-500 mb-4">Souls</h3>
            <div id="follow-list-content" class="max-h-80 overflow-y-auto space-y-3 pr-2">
                <!-- User list populated by JS -->
            </div>
        </div>
    </div>

    <!-- HOW IT WORKS MODAL -->
    <div id="modal-how-it-works" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-2xl p-8 rounded-lg border border-white/10 relative max-h-[90vh] flex flex-col">
            <button onclick="ui.closeModal('modal-how-it-works')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h3 class="font-horror text-3xl text-red-500 mb-4">Grimoire Guide</h3>
            <div class="flex-grow overflow-y-auto pr-4 space-y-6 text-gray-400 text-sm leading-relaxed font-story">
                <div>
                    <h4 class="font-bold text-lg text-white mb-2">Welcome to the Void</h4>
                    <p>Grimoire is a sanctuary for authentic horror writers. We value human creativity above all else. This is a place to share your darkest tales, collaborate with others, and build communities around the genres you love. AI-generated content is strictly forbidden and will be purged.</p>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-white mb-2">Credits (CR) - The Currency of Souls</h4>
                    <p>Credits are the lifeblood of Grimoire. They are used to manifest your stories and reward the creators you admire. Here's how to earn them:</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-300">
                        <li><b class="text-green-400">Sign Up Bonus:</b> New souls receive <span class="font-mono text-yellow-400">50 CR</span>.</li>
                        <li><b class="text-green-400">Daily Ritual:</b> Claim <span class="font-mono text-yellow-400">50 CR</span> every 24 hours. Consecutive daily claims may yield greater rewards.</li>
                        <li><b class="text-green-400">First Post:</b> Publish your first story for a <span class="font-mono text-yellow-400">25 CR</span> bonus.</li>
                        <li><b class="text-green-400">Story Milestones:</b> Earn <span class="font-mono text-yellow-400">10 CR</span> at 10 likes, <span class="font-mono text-yellow-400">50 CR</span> at 50 likes, and <span class="font-mono text-yellow-400">100 CR</span> at 100 likes on a single story.</li>
                        <li><b class="text-green-400">Accepted Suggestions:</b> If an author accepts your suggested edit, you earn <span class="font-mono text-yellow-400">20 CR</span>.</li>
                        <li><b class="text-green-400">Receive Tips:</b> Other users can tip your stories directly with CR.</li>
                        <li><b class="text-green-400">Found a Coven:</b> Establishing a new community costs <span class="font-mono text-yellow-400">100 CR</span>.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-bold text-lg text-white mb-2">Coven Rewards</h4>
                    <p>Being part of an active Coven provides unique opportunities to earn credits:</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-300">
                        <li><b class="text-purple-400">Join Fee Payouts:</b> When a new coveneer pays a fee to join, the credits are distributed among the Coven's leadership. The Founder receives the largest share, with Elders also receiving a portion.</li>
                        <li><b class="text-purple-400">Featured Posts:</b> Coven founders can feature a coveneer's post, granting the author a <span class="font-mono text-yellow-400">25 CR</span> bonus.</li>
                        <li><b class="text-purple-400">Coven Milestones:</b> When your Coven reaches milestones (e.g., 25 coveneers), all active coveneers may receive a bonus.</li>
                        <li><b class="text-purple-400">Weekly Activity:</b> The most active Covens each week (based on new posts, comments, and coveneers) grant a passive <span class="font-mono text-yellow-400">CR</span> bonus to all their coveneers.</li>
                    </ul>
                </div>
                 <div>
                    <h4 class="font-bold text-lg text-white mb-2">Ranks & Badges</h4>
                    <p>Your Rank reflects your standing and contributions within the Grimoire. It increases as you earn more credits. You can also earn unique Badges for special achievements.</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-300">
                        <li><b class="text-red-400">Ranks:</b> Neophyte, Acolyte, Cultist, Warlock, Elder God.</li>
                        <li><b class="text-yellow-400">Badges:</b> Look for icons on profiles for achievements like founding a Coven, being a prolific writer, or being a generous patron.</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-bold text-lg text-white mb-2">Soul Verification</h4>
                    <p>Verified Souls are beacons in the Void, writers and patrons who have garnered significant influence. A verified soul is marked with a <span class="text-red-500"><i class="fas fa-check-circle"></i></span> badge.</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1 text-gray-300">
                        <li><b>Requirement:</b> Amass <span class="font-mono text-yellow-400">100</span> or more followers.</li>
                        <li><b>Benefit:</b> Your standing is recognized across the Grimoire, lending weight to your words and creations.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- AVATAR CROPPER MODAL (IMPROVED) -->
    <div id="cropper-modal" class="fixed inset-0 z-[120] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-md p-8 rounded-xl">
            <h3 class="font-horror text-3xl text-white mb-4 text-center">Shape Your Visage</h3>
            <p class="text-center text-gray-500 mb-6 text-sm">A circle, to contain the soul.</p>
            <div id="cropper-image-container">
                <img id="cropper-image" src="">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="ui.closeModal('cropper-modal')" class="btn-secondary">Cancel</button>
                <button id="crop-confirm-btn" class="btn-main">Confirm</button>
            </div>
        </div>
    </div>


    <!-- REPORT MODAL -->
    <div id="modal-report" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass max-w-sm w-[90%] p-6 rounded-lg border border-red-900/40">
            <h3 class="font-horror text-2xl text-red-500 mb-4">Report Anomaly</h3>
            <div class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-2">
                <button onclick="reader.submitReport('AI Content')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">AI Generated Content</button>
                <button onclick="reader.submitReport('Harassment')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">Harassment / Hate Speech</button>
                <button onclick="reader.submitReport('Spam')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">Spam / Bot Activity</button>
                <button onclick="reader.submitReport('Plagiarism')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">Plagiarism / Stolen Work</button>
                <button onclick="reader.submitReport('Gore')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">Excessive Real Gore</button>
                <button onclick="reader.submitReport('Off Topic')" class="w-full text-left p-3 rounded bg-white/5 hover:bg-red-900/20 border border-transparent hover:border-red-900 transition-colors text-sm font-bold text-gray-400 hover:text-white">Wrong Community / Off Topic</button>
            </div>
            <button onclick="ui.closeModal('modal-report')" class="btn-secondary w-full">Cancel</button>
        </div>
    </div>

    <!-- THREAD MODAL (Redesigned) -->
    <div id="modal-thread" class="fixed inset-0 z-[90] bg-black/95 hidden flex justify-center backdrop-blur-md overflow-y-auto">
        <div class="w-full max-w-4xl min-h-screen glass-thread relative shadow-2xl flex flex-col">
            
            <div class="sticky top-0 z-20 bg-[#050505]/95 backdrop-blur-lg border-b border-white/10 p-4 flex items-center justify-between">
                <button onclick="threadView.close()" class="text-gray-500 hover:text-white transition-colors flex items-center gap-2 text-xs font-bold uppercase tracking-wider"><i class="fas fa-arrow-left"></i> Return</button>
                <h3 class="font-horror text-xl text-red-800 tracking-widest">Thread</h3>
            </div>

            <div class="flex-grow p-4 md:p-8 overflow-y-auto">
                <!-- Original Post -->
                <div id="thread-main-content" class="mb-8">
                    <!-- Filled by JS -->
                </div>
                
                <!-- Reply Box to Main Thread -->
                <div class="p-4 border-t border-white/10 bg-[#080808] rounded-lg mb-8">
                    <div class="flex gap-3">
                        <div class="w-8 h-8 rounded-full bg-gray-900 overflow-hidden flex-shrink-0 border border-white/10">
                            <img id="thread-my-avatar" class="w-full h-full object-cover opacity-70">
                        </div>
                        <div class="flex-1 relative group">
                            <textarea id="thread-reply-input" class="w-full bg-[#0a0a0a] border border-white/10 rounded p-3 text-gray-300 placeholder-gray-700 h-24 resize-none font-story text-sm focus:border-red-900 transition-all outline-none" placeholder="Whisper your reply to the thread..."></textarea>
                            <div class="flex justify-end mt-2">
                                <button onclick="threadView.postReply()" class="px-4 py-1.5 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-xs font-bold uppercase rounded transition-colors">Reply</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="border-t border-white/10 pt-6">
                     <div class="flex justify-between items-center mb-6">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Echoes in the Dark</span>
                        <span id="thread-comment-count-badge" class="bg-white/5 px-2 py-1 rounded text-gray-400 text-xs">0</span>
                    </div>
                    <div id="thread-comments-list" class="space-y-6">
                        <!-- Comments populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- CREATE COMMUNITY MODAL -->
    <div id="modal-create-coven" class="fixed inset-0 z-[110] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-md p-8 rounded-xl border border-red-900/40 relative">
            <button onclick="ui.closeModal('modal-create-coven')" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="font-horror text-3xl text-red-500 mb-6">Found a Coven</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase">Coven Name</label>
                    <input type="text" id="coven-name" class="input-void" placeholder="The Midnight Order">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase">Description</label>
                    <textarea id="coven-desc" class="input-void h-20 resize-none" placeholder="What gathers here?"></textarea>
                </div>
                 <div>
                    <label class="text-xs text-gray-500 uppercase">Join Fee</label>
                    <div class="mt-2 space-y-2">
                        <label for="coven-fee-required" class="flex items-center cursor-pointer">
                            <input type="checkbox" id="coven-fee-required" class="appearance-none w-4 h-4 border-2 border-gray-600 rounded bg-black/40 checked:bg-yellow-600 checked:border-yellow-500 transition-colors" onchange="ui.toggleFeeOptions(this.checked)">
                            <span class="ml-2 text-sm text-gray-400">Require a fee to join</span>
                        </label>
                        <div id="coven-fee-options" class="hidden pt-2 flex items-center justify-center gap-3">
                            <!-- Option 5 -->
                            <div>
                                <input type="radio" name="coven-fee" value="5" id="fee-5" class="hidden peer">
                                <label for="fee-5" class="block cursor-pointer text-yellow-500 font-mono border-2 border-gray-700 rounded px-3 py-1 text-xs hover:border-yellow-700 transition-colors peer-checked:border-yellow-500 peer-checked:bg-yellow-900/50">
                                    5 CR
                                </label>
                            </div>
                            <!-- Option 10 -->
                            <div>
                                <input type="radio" name="coven-fee" value="10" id="fee-10" class="hidden peer" checked>
                                <label for="fee-10" class="block cursor-pointer text-yellow-500 font-mono border-2 border-gray-700 rounded px-3 py-1 text-xs hover:border-yellow-700 transition-colors peer-checked:border-yellow-500 peer-checked:bg-yellow-900/50">
                                    10 CR
                                </label>
                            </div>
                            <!-- Option 25 -->
                            <div>
                                <input type="radio" name="coven-fee" value="25" id="fee-25" class="hidden peer">
                                <label for="fee-25" class="block cursor-pointer text-yellow-500 font-mono border-2 border-gray-700 rounded px-3 py-1 text-xs hover:border-yellow-700 transition-colors peer-checked:border-yellow-500 peer-checked:bg-yellow-900/50">
                                    25 CR
                                </label>
                            </div>
                            <!-- Option 50 -->
                            <div>
                                <input type="radio" name="coven-fee" value="50" id="fee-50" class="hidden peer">
                                <label for="fee-50" class="block cursor-pointer text-yellow-500 font-mono border-2 border-gray-700 rounded px-3 py-1 text-xs hover:border-yellow-700 transition-colors peer-checked:border-yellow-500 peer-checked:bg-yellow-900/50">
                                    50 CR
                                </label>
                            </div>
                        </div>
                    </div>
                    <p id="coven-fee-desc" class="text-[10px] text-gray-600 mt-2">Covens are free to join by default. If a fee is required, it is transferred to the Coven founder and Elders.</p>
                </div>
                <div class="relative h-32 border-2 border-dashed border-gray-800 rounded-lg hover:border-red-900 transition-colors cursor-pointer group overflow-hidden bg-black/20" onclick="document.getElementById('coven-img-upload').click()">
                    <input type="file" id="coven-img-upload" class="hidden" accept="image/*">
                    <img id="coven-img-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 group-hover:text-red-500 transition-colors">
                        <i class="fas fa-image text-2xl mb-1"></i>
                        <span class="text-xs font-bold uppercase">Cover Image</span>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/10">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-xs text-gray-400">Cost to Establish</span>
                        <span class="text-yellow-500 font-mono">100 CR</span>
                    </div>
                    <button onclick="communities.create()" class="btn-main w-full">
                        Sacrifice & Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUTH SCREEN -->
    <section id="view-auth" class="view-section min-h-screen flex items-center justify-center p-4 relative z-20 hidden">
        <div class="glass w-full max-w-md p-10 rounded-2xl border-t-4 border-red-900 shadow-[0_0_60px_rgba(0,0,0,0.8)]">
            <div class="text-center mb-10">
                <i class="fas fa-book-skull text-5xl text-red-800 mb-4 animate-pulse"></i>
                <h1 class="font-horror text-6xl text-white tracking-widest">Grimoire</h1>
                <p class="text-gray-600 text-sm mt-2 tracking-widest uppercase">Chronicles of the Void</p>
            </div>

            <form id="form-login" onsubmit="event.preventDefault(); auth.login();" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email Address" class="input-void" required>
                <input type="password" id="login-pass" placeholder="Password" class="input-void" required>
                <button type="submit" class="btn-main w-full py-3 mt-4">Enter the Void</button>
                <div class="text-center mt-6 pt-6 border-t border-white/5">
                    <p class="text-xs text-gray-500">New soul? <span onclick="ui.toggleAuth('signup')" class="text-red-500 cursor-pointer hover:text-red-400 transition-colors">Sign Creation Pact</span></p>
                </div>
            </form>

            <form id="form-signup" onsubmit="event.preventDefault(); auth.signup();" class="space-y-4 hidden">
                <div class="text-center">
                    <div class="w-24 h-24 mx-auto rounded-full border-2 border-red-900 overflow-hidden relative group cursor-pointer bg-black" onclick="document.getElementById('signup-avatar-input').click()">
                        <img id="signup-avatar-preview" src="https://ui-avatars.com/api/?name=?&background=111&color=555" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/60 hidden group-hover:flex items-center justify-center text-white"><i class="fas fa-camera"></i></div>
                    </div>
                    <input type="file" id="signup-avatar-input" class="hidden" accept="image/*">
                </div>
                <div>
                    <input type="text" id="signup-name" placeholder="Chosen Name" class="input-void" required autocomplete="off">
                    <p id="signup-username-feedback" class="hidden text-xs font-bold mt-1"></p>
                </div>
                <input type="email" id="signup-email" placeholder="Email Address" class="input-void" required>
                <input type="password" id="signup-pass" placeholder="Password (Min 6)" class="input-void" required>
                <textarea id="signup-bio" class="input-void h-20 resize-none" placeholder="A brief bio..."></textarea>
                <input type="text" id="signup-link" class="input-void" placeholder="Website Link (optional)">
                <button type="submit" class="btn-main w-full py-3 mt-4" id="btn-signup-submit">Sign in Blood</button>
                <div class="text-center mt-6 pt-6 border-t border-white/5">
                    <p class="text-xs text-gray-500">Existing soul? <span onclick="ui.toggleAuth('login')" class="text-red-500 cursor-pointer hover:text-red-400 transition-colors">Return</span></p>
                </div>
            </form>
        </div>
    </section>

    <!-- APP SHELL -->
    <div id="app-shell" class="hidden relative z-10 min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav class="sticky top-0 z-50 glass h-16 border-b border-white/5">
            <div class="container mx-auto px-4 h-full flex items-center justify-between">
			<div class="flex items-center gap-2 cursor-pointer group" onclick="router.go('home')">
				<i class="fas fa-ghost text-red-600 text-2xl ghost-icon"></i>
				<span class="font-horror text-xl hidden md:block grimoire-text">Grimoire</span>
			</div>

                <div class="flex items-center gap-2 bg-black/40 p-1 rounded-lg border border-white/5">
                    <button onclick="router.go('home')" title="Feed" class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2">
                        <i class="fas fa-stream"></i> <span class="hidden md:inline">Feed</span>
                    </button>
                    <button onclick="router.go('explore')" title="Abyss" class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-widest text-gray-400 hover:text-white hover:bg-white/5 transition-all flex items-center gap-2">
                        <i class="fas fa-compass"></i> <span class="hidden md:inline">Abyss</span>
                    </button>
                    <button onclick="creator.startNewStory()" title="Create" class="px-3 py-1.5 rounded text-xs font-bold uppercase tracking-widest text-red-700 hover:text-red-500 hover:bg-red-900/10 transition-all flex items-center gap-2">
                        <i class="fas fa-pen-fancy"></i> <span class="hidden md:inline">Create</span>
                    </button>
                </div>

                <div class="flex items-center gap-4">
                    <div class="relative group cursor-pointer" onclick="rewards.claim()" title="Daily Reward">
                        <i class="fas fa-chest text-yellow-600 hover:text-yellow-400 transition-colors"></i>
                        <div id="reward-dot" class="hidden absolute -top-1 -right-1 w-2 h-2 bg-green-500 rounded-full animate-ping"></div>
                    </div>

					<!-- Inside navbar, look for notifications.toggle() section -->
					<div class="relative group cursor-pointer" onclick="notifications.toggle()">
						<i class="fas fa-bell text-gray-400 hover:text-white transition-colors"></i>
						<div id="notif-badge" class="hidden absolute -top-1 -right-1 w-2 h-2 bg-red-600 rounded-full"></div>
						
						<!-- UPDATED DROPDOWN HTML -->
						<div id="notif-dropdown" class="hidden fixed top-16 right-2 left-2 w-auto md:absolute md:top-full md:right-0 md:left-auto md:w-80 glass rounded-lg border border-white/10 p-0 overflow-hidden shadow-2xl z-[100]">
							<div class="p-3 bg-black/90 border-b border-white/5 flex justify-between items-center">
								<span class="font-bold text-xs text-gray-400 tracking-wider">NOTIFICATIONS</span>
								<button onclick="event.stopPropagation(); notifications.clearAll()" class="text-[10px] text-red-500 hover:text-red-300 uppercase font-bold tracking-wide border border-red-900/50 px-2 py-0.5 rounded bg-red-900/10 hover:bg-red-900/30 transition-all">Clear</button>
							</div>
							<div id="notif-list" class="max-h-64 overflow-y-auto bg-black/90"></div>
							<div id="notif-empty" class="hidden p-8 text-center">
								<i class="fas fa-bell-slash text-2xl text-gray-700 mb-2"></i>
								<p class="text-xs text-gray-600 italic">No new nightmares...</p>
							</div>
						</div>
					</div>

                    <div class="flex flex-col items-end cursor-pointer group" onclick="profile.viewSelf()">
                        <span id="nav-user" class="text-xs font-bold text-gray-300 group-hover:text-white hidden md:block">User</span>
                        <span class="text-[10px] text-yellow-600 font-mono tracking-wide"><i class="fas fa-coins mr-1"></i><span id="nav-credits">0</span></span>
                    </div>
                    <button onclick="auth.logout()" class="text-gray-500 hover:text-red-500 transition-colors"><i class="fas fa-sign-out text-lg"></i></button>
                </div>
            </div>
        </nav>

        <!-- MAIN -->
        <main class="flex-grow container mx-auto px-4 py-8 max-w-7xl">

            <!-- VIEW: FEED -->
            <section id="view-home" class="view-section animate-in">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-white tracking-tight truncate max-w-[200px] md:max-w-md" id="feed-title">Chronicles</h2>
                    <div class="relative w-full md:w-80 group">
                        <input type="text" id="feed-search" placeholder="Search the void..." class="w-full bg-black/60 border border-white/10 rounded-lg py-3 px-4 pl-10 pr-10 text-sm focus:outline-none focus:border-red-900 focus:bg-black/80 transition-colors shadow-lg">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-600 group-hover:text-red-500 transition-colors pointer-events-none"></i>
                        <i id="feed-search-clear" class="fas fa-times absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 cursor-pointer hidden hover:text-white"></i>
                    </div>
                    <div class="flex gap-2 w-full md:w-auto overflow-x-auto">
                        <button onclick="feed.sort('new')" id="sort-new" class="btn-secondary text-xs active bg-white/5 text-white whitespace-nowrap">Newest</button>
                        <button onclick="feed.sort('hot')" id="sort-hot" class="btn-secondary text-xs whitespace-nowrap">Hottest</button>
                        <button onclick="feed.sort('following')" id="sort-following" class="btn-secondary text-xs border-purple-900 text-purple-400 hover:border-purple-500 whitespace-nowrap">Following</button>
                    </div>
                </div>

                <!-- Sponsored Covens -->
                <div id="sponsored-covens-container" class="mb-8 hidden">
                     <h3 class="text-xs font-bold text-yellow-500 uppercase tracking-widest mb-4">Sponsored Covens</h3>
                     <div id="sponsored-covens-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                         <!-- JS Populated -->
                     </div>
                </div>

                <!-- User Suggestions -->
                <div id="user-suggestions-container" class="mb-8 hidden">
                     <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Souls to Follow</h3>
                     <div class="relative">
                        <div id="user-suggestions-scroller" class="overflow-hidden scroller">
                             <div class="flex gap-4">
                                 <div id="user-suggestions-grid" class="flex gap-4 scrolling-wrapper">
                                     <!-- JS Populated -->
                                 </div>
                                 <div id="user-suggestions-grid-clone" class="flex gap-4 scrolling-wrapper" aria-hidden="true">
                                     <!-- JS Populated Clone -->
                                 </div>
                             </div>
                        </div>
                     </div>
                </div>
                
                <div id="feed-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="feed-empty" class="hidden text-center py-24 opacity-50">
                    <i class="fas fa-spider text-4xl mb-4 text-gray-600"></i>
                    <p>The void is empty.</p>
                </div>
            </section>

            <!-- VIEW: PROFILE -->
            <section id="view-profile" class="view-section hidden animate-in">
                <div class="glass rounded-xl overflow-hidden mb-8 border-t border-white/10 relative">
                     <!-- CHANGE: Replaced profile header with a more atmospheric one -->
                     <div class="h-40 bg-black relative overflow-hidden border-b border-white/5">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-sharp-edges.png')] opacity-25"></div>
                        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_rgba(138,3,3,0.3)_0%,_rgba(0,0,0,1)_80%)] animate-pulse-slow"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                     </div>
                     <div class="px-4 md:px-8 pb-8 relative">
                         <!-- Improved Mobile Layout Structure -->
                         <div class="flex flex-col md:flex-row gap-6 items-center md:items-end -mt-16 md:-mt-16">
                             <div id="profile-img-container" class="w-32 h-32 rounded-full border-4 border-[#050505] overflow-hidden bg-black shadow-xl relative group flex-shrink-0">
                                 <img id="profile-view-img" class="w-full h-full object-cover">
                                 <div id="profile-img-edit-overlay" class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center cursor-pointer text-white/80 text-xs uppercase font-bold" onclick="document.getElementById('btn-edit-profile').click()">Edit</div>
                             </div>
                             <div class="flex-1 mb-2 text-center md:text-left w-full">
                                 <div class="flex flex-col md:flex-row items-center md:justify-start gap-2 md:gap-3">
                                    <h2 id="profile-view-name" class="text-3xl font-bold text-white font-story tracking-tight">Username</h2>
                                    <div class="flex items-center gap-2">
                                        <span id="profile-leaderboard-rank" class="text-[10px] uppercase font-bold px-2 py-0.5 rounded border border-yellow-900 text-yellow-500 tracking-widest bg-yellow-900/10 hidden">#0</span>
                                        <span id="profile-rank" class="text-[10px] uppercase font-bold px-2 py-0.5 rounded border border-red-900 text-red-500 tracking-widest bg-red-900/10">Neophyte</span>
                                        <div id="profile-badges" class="flex items-center gap-2 text-yellow-400"></div>
                                    </div>
                                 </div>
                                 <p id="profile-view-bio" class="text-gray-400 text-sm mt-2 max-w-lg leading-relaxed mx-auto md:mx-0">Bio goes here...</p>
                                 <div id="profile-view-joined" class="text-xs text-gray-600 mt-3 font-mono hidden"><i class="fas fa-clock mr-1"></i></div>
                                 <div id="profile-links" class="mt-3 flex justify-center md:justify-start gap-3 text-xs text-blue-400 font-mono"></div>
                             </div>
                             
                             <div class="grid grid-cols-3 gap-3 mb-4 w-full md:w-auto">
                                 <div onclick="profile.showFollowList('followers')" class="stats-card group clickable">
                                     <div id="profile-view-followers" class="font-bold text-white text-xl font-mono group-hover:text-red-500 transition-colors">0</div>
                                     <div class="text-[9px] text-gray-500 uppercase tracking-widest mt-1">Followers</div>
                                 </div>
                                 <div onclick="profile.showFollowList('following')" class="stats-card group clickable">
                                     <div id="profile-view-following" class="font-bold text-white text-xl font-mono group-hover:text-red-500 transition-colors">0</div>
                                     <div class="text-[9px] text-gray-500 uppercase tracking-widest mt-1">Following</div>
                                 </div>
                                 <div class="stats-card group">
                                     <div id="profile-view-likes" class="font-bold text-white text-xl font-mono group-hover:text-red-500 transition-colors">0</div>
                                     <div class="text-[9px] text-gray-500 uppercase tracking-widest mt-1">Likes</div>
                                 </div>
                             </div>

                             <div class="mb-4 flex flex-col items-center justify-center gap-2 w-full md:w-auto">
                                 <button id="btn-follow" class="btn-main py-2 px-8 text-xs hidden shadow-lg w-full md:w-auto" onclick="profile.toggleFollow()">Follow</button>
                                 <button id="btn-edit-profile" class="btn-secondary py-2 px-6 text-xs hidden border-white/20 hover:bg-white/10 text-gray-300 w-full md:w-auto" onclick="ui.openProfileEditor()">Edit Profile</button>
                                 <button onclick="ui.openModal('modal-how-it-works')" class="text-gray-600 hover:text-white transition-colors text-xs flex items-center gap-1"><i class="fas fa-question-circle"></i> How It Works</button>
                             </div>
                         </div>
                     </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-6 border-b border-white/5 mb-6 overflow-x-auto">
                    <button onclick="profile.switchTab('artifacts')" id="tab-artifacts" class="profile-tab active whitespace-nowrap">Artifacts</button>
                    <button onclick="profile.switchTab('allies')" id="tab-allies" class="profile-tab whitespace-nowrap">Allies</button>
                    <button onclick="profile.switchTab('covens')" id="tab-covens" class="profile-tab whitespace-nowrap">Covens</button>
                </div>

                <div id="profile-content-area" class="min-h-[200px]">
                    <!-- Dynamic Content Loaded Here -->
                </div>

            </section>

            <!-- VIEW: EXPLORE (The Abyss) -->
            <section id="view-explore" class="view-section hidden animate-in">
                <div class="max-w-5xl mx-auto">
                    <div class="text-center mb-12">
                        <h2 class="font-horror text-5xl text-red-800 mb-6 drop-shadow-lg">The Abyss</h2>
                        <div class="relative group max-w-xl mx-auto">
                            <input type="text" id="explore-search" placeholder="Search for Covens..." class="w-full bg-black/60 border border-white/10 rounded-lg py-4 px-6 pl-14 pr-14 text-lg focus:outline-none focus:border-red-900 focus:bg-black/80 transition-colors shadow-2xl">
                            <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-600 group-hover:text-red-500 transition-colors pointer-events-none"></i>
                            <i id="explore-search-clear" class="fas fa-times absolute right-5 top-1/2 -translate-y-1/2 text-gray-600 cursor-pointer hidden hover:text-white"></i>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Left Side -->
                        <div class="md:col-span-2 space-y-8">
                            <div>
                                <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Active Covens</h3>
                                    <button onclick="ui.openModal('modal-create-coven')" class="text-[10px] text-purple-400 hover:text-purple-300 font-bold uppercase border border-purple-900 px-3 py-1 rounded hover:bg-purple-900/20 transition-colors">
                                        <i class="fas fa-plus mr-1"></i> Found a Coven
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="communities-grid"></div>
                                <div id="communities-empty" class="hidden text-center text-gray-600 py-12">No Covens found.</div>
                            </div>
                        </div>

                        <!-- Right Side -->
                        <div class="space-y-8">
                             <div>
                                 <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Realms of Terror</h3>
                                 <div class="grid grid-cols-2 gap-3">
                                     <div onclick="feed.filter('Paranormal')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-ghost text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Paranormal</h4></div>
                                     <div onclick="feed.filter('Psychological')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-brain text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Psych</h4></div>
                                     <div onclick="feed.filter('Slasher')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-mask text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Slasher</h4></div>
                                     <div onclick="feed.filter('Cosmic')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-meteor text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Cosmic</h4></div>
                                     <div onclick="feed.filter('Urban Legend')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-city text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Urban</h4></div>
                                     <div onclick="feed.filter('Folk Horror')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-tree text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Folk</h4></div>
                                     <div onclick="feed.filter('Body Horror')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-bone text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Body Horror</h4></div>
                                     <div onclick="feed.filter('Gothic')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-church text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Gothic</h4></div>
                                     <div onclick="feed.filter('Survival')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-skull-crossbones text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Survival</h4></div>
                                     <div onclick="feed.filter('Eldritch')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-eye text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Eldritch</h4></div>
                                     <div onclick="feed.filter('Found Footage')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-film text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Found Footage</h4></div>
                                     <div onclick="feed.filter('Occult')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-book-skull text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Occult</h4></div>
                                     <div onclick="feed.filter('Monster')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-paw text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Monster</h4></div>
                                     <div onclick="feed.filter('Dystopian')" class="glass p-3 rounded hover:border-red-900 cursor-pointer transition-all hover:-translate-y-1 group flex items-center gap-3"><i class="fas fa-robot text-lg text-gray-700 group-hover:text-white transition-colors"></i><h4 class="font-bold text-gray-400 group-hover:text-red-500 text-xs">Dystopian</h4></div>
                                 </div>
                             </div>
                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Worshipped Souls</h3>
                                <div class="flex flex-col gap-3" id="trending-users-grid"></div>
                            </div>

                            <div>
                                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Fresh Blood</h3>
                                <div class="flex flex-col gap-3" id="fresh-users-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: COMMUNITY DETAILS -->
            <section id="view-community" class="view-section hidden animate-in">
                <div class="max-w-5xl mx-auto">
                    <button onclick="router.back()" class="mb-6 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white flex items-center gap-2 transition-colors"><i class="fas fa-arrow-left"></i> Return to Abyss</button>
                    
                    <!-- MOBILE FIX: Updated Layout to flex-col for mobile, flex-row for desktop to prevent text overflow -->
                    <div class="relative rounded-xl overflow-hidden min-h-[350px] md:h-64 mb-8 group bg-black">
                        <img id="coven-hero-img" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 grayscale group-hover:grayscale-0 absolute inset-0 opacity-60">
                        <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
                        
                        <div class="absolute inset-0 p-6 md:p-8 flex flex-col md:flex-row justify-end items-start md:items-end gap-4 z-10">
                            <div class="w-full">
                                <h1 id="coven-hero-name" class="font-horror text-3xl md:text-5xl text-red-500 drop-shadow-lg mb-2 leading-none break-words">Coven Name</h1>
                                <p id="coven-hero-desc" class="text-gray-300 max-w-2xl text-xs md:text-sm line-clamp-3">Description...</p>
                                <div class="flex flex-wrap items-center gap-4 mt-4 text-xs text-gray-400 font-mono">
                                    <span class="cursor-pointer hover:text-white" onclick="communities.showMembers()"><i class="fas fa-users mr-2"></i><span id="coven-member-count">0</span> Coveneers</span>
                                    <span><i class="fas fa-crown mr-2"></i><span id="coven-creator">Creator</span></span>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full md:w-auto">
                                <button id="btn-coven-sponsor" onclick="communities.sponsor()" class="btn-main hidden border-yellow-600 text-yellow-400 hover:bg-yellow-900/30 text-xs justify-center">Sponsor (100 CR)</button>
                                <button id="btn-coven-join" onclick="communities.toggleJoin()" class="btn-main border-red-600 text-red-400 hover:bg-red-900/30 justify-center">Join Coven</button>
                                <button onclick="communities.triggerPost()" class="btn-main justify-center">Whisper to Coven</button>
                            </div>
                        </div>
                    </div>

                    <div id="coven-pinned-section" class="mb-8 hidden">
                        <h3 class="font-horror text-2xl text-yellow-400 mb-4 tracking-wider border-b-2 border-yellow-900/50 pb-2">Pinned by Elders</h3>
                        <div id="coven-pinned-grid" class="space-y-4 pt-4">
                            <!-- Pinned posts will be loaded here by JS -->
                        </div>
                    </div>

                    <div>
                        <h3 class="font-horror text-2xl text-gray-500 mb-6">Whispers & Threads</h3>
                        <div id="coven-feed-grid" class="space-y-4"></div>
                         <div id="coven-feed-empty" class="hidden text-center text-gray-600 py-12">
                            <i class="fas fa-spider text-4xl mb-3"></i>
                            <p class="italic">Echoes are silent here... be the first to whisper.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: CREATE / SUGGEST -->
            <section id="view-create" class="view-section hidden animate-in">
                <div class="max-w-4xl mx-auto">
                    <header class="flex justify-between items-center mb-6 pb-4 border-b border-white/5">
                        <div>
                            <h2 class="font-horror text-2xl md:text-3xl text-white" id="create-header-title">Manifest Nightmare</h2>
                            <p class="text-xs text-gray-500 mt-1" id="create-header-sub">Authentic Horror Only. No AI.</p>
                        </div>
                        <div class="text-right bg-black/40 p-3 rounded border border-white/5">
                            <span class="text-[10px] text-gray-500 uppercase block">Total Cost</span>
                            <div id="create-cost" class="font-mono text-xl text-red-500 font-bold">0 CR</div>
                        </div>
                    </header>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="md:col-span-2 space-y-4" id="create-form-left">
                            <div id="post-type-toggle-container" class="hidden flex bg-black/40 p-1 rounded border border-white/5 w-fit mb-2">
                                <button onclick="creator.setType('story')" id="type-story" class="px-4 py-1 text-xs uppercase font-bold rounded bg-red-900/30 text-white">Story</button>
                                <button onclick="creator.setType('thread')" id="type-thread" class="px-4 py-1 text-xs uppercase font-bold rounded text-gray-500 hover:text-white">Thread</button>
                            </div>

                            <input type="text" id="create-title" placeholder="Title" class="input-void text-xl font-bold bg-transparent border-none px-0 rounded-none border-b focus:border-red-800 focus:shadow-none placeholder-gray-700">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div class="custom-select" id="cat-dropdown" onclick="ui.toggleSelect('cat-dropdown')">
                                    <div class="select-selected" id="cat-selected">Select Realm</div>
                                    <div class="select-items">
                                        <div onclick="ui.selectOption('cat', 'Paranormal')">Paranormal</div>
                                        <div onclick="ui.selectOption('cat', 'Psychological')">Psychological</div>
                                        <div onclick="ui.selectOption('cat', 'Slasher')">Slasher</div>
                                        <div onclick="ui.selectOption('cat', 'Cosmic')">Cosmic</div>
                                        <div onclick="ui.selectOption('cat', 'Urban Legend')">Urban Legend</div>
                                        <div onclick="ui.selectOption('cat', 'Folk Horror')">Folk Horror</div>
                                        <div onclick="ui.selectOption('cat', 'Body Horror')">Body Horror</div>
                                        <div onclick="ui.selectOption('cat', 'Gothic')">Gothic</div>
                                        <div onclick="ui.selectOption('cat', 'Survival')">Survival</div>
                                        <div onclick="ui.selectOption('cat', 'Eldritch')">Eldritch</div>
                                        <div onclick="ui.selectOption('cat', 'Found Footage')">Found Footage</div>
                                        <div onclick="ui.selectOption('cat', 'Occult')">Occult</div>
                                        <div onclick="ui.selectOption('cat', 'Monster')">Monster</div>
                                        <div onclick="ui.selectOption('cat', 'Dystopian')">Dystopian</div>
                                    </div>
                                </div>
                                <input type="text" id="create-tags" placeholder="Tags (comma separated)" class="input-void">
                            </div>
                            <textarea id="create-desc" placeholder="Brief description..." class="input-void h-24 resize-none"></textarea>
                        </div>

                        <div id="cover-upload-container" class="relative h-full min-h-[200px] border-2 border-dashed border-gray-800 rounded-lg hover:border-red-900 transition-colors cursor-pointer group overflow-hidden bg-black/20" onclick="document.getElementById('cover-input').click()">
                            <input type="file" id="cover-input" class="hidden" accept="image/*">
                            <img id="cover-preview" class="absolute inset-0 w-full h-full object-cover hidden">
                            <div id="cover-label" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 group-hover:text-red-500 transition-colors">
                                <i class="fas fa-image text-3xl mb-2"></i>
                                <span class="text-xs font-bold uppercase tracking-wider">Upload Cover</span>
                                <span class="text-[10px] text-gray-700 mt-1">Max 1MB</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="coven-options" class="hidden space-y-3 bg-black/20 p-4 rounded-lg border border-white/10 mb-6">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Coven Post Options</h4>
                        <label class="flex items-center gap-3 cursor-pointer" for="create-members-only">
                            <input type="checkbox" id="create-members-only" class="appearance-none w-4 h-4 border-2 border-gray-600 rounded bg-black/40 checked:bg-red-800 checked:border-red-600 transition-colors">
                            <span class="text-sm text-gray-400">Coveneers-Only Access</span>
                        </label>
                        <p class="text-xs text-gray-600 -mt-2 ml-7">If checked, only coveneers of the coven can view this story.</p>
                        <!-- Placeholder for future collab feature -->
                        <label class="flex items-center gap-3 cursor-not-allowed opacity-50" for="create-collab">
                            <input type="checkbox" id="create-collab" disabled class="appearance-none w-4 h-4 border-2 border-gray-600 rounded bg-black/40">
                            <span class="text-sm text-gray-400">Start a Collaboration (Coming Soon)</span>
                        </label>
                    </div>


                    <div class="glass border-b-0 rounded-t-lg p-3 flex gap-2 items-center flex-wrap toolbar-layer">
                        <button onclick="document.execCommand('bold')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0" title="Bold"><i class="fas fa-bold"></i></button>
                        <button onclick="document.execCommand('italic')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0" title="Italic"><i class="fas fa-italic"></i></button>
                        <button onclick="document.execCommand('insertOrderedList')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0" title="Ordered List"><i class="fas fa-list-ol"></i></button>
                        <button onclick="document.execCommand('insertUnorderedList')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0" title="Unordered List"><i class="fas fa-list-ul"></i></button>
                        <div class="w-px h-5 bg-white/10 mx-2 flex-shrink-0"></div>
                        <button onclick="document.execCommand('justifyLeft')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0"><i class="fas fa-align-left"></i></button>
                        <button onclick="document.execCommand('justifyCenter')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0"><i class="fas fa-align-center"></i></button>
                        <button onclick="document.execCommand('justifyRight')" class="w-8 h-8 flex items-center justify-center hover:bg-white/10 rounded text-gray-400 flex-shrink-0"><i class="fas fa-align-right"></i></button>
                        <div class="w-px h-5 bg-white/10 mx-2 flex-shrink-0"></div>
                        
                        <div class="flex items-center bg-black/40 rounded border border-white/10 flex-shrink-0">
                             <div class="custom-select" id="img-scale-select" style="min-width: 80px; border: none;" onclick="ui.toggleSelect('img-scale-select')">
                                 <div class="select-selected" id="img-scale-selected" style="background: transparent; border: none; padding: 8px;">Full</div>
                                 <div class="select-items">
                                     <div onclick="ui.selectImgScale('100%', 'Full')">Full</div>
                                     <div onclick="ui.selectImgScale('75%', '75%')">75%</div>
                                     <div onclick="ui.selectImgScale('50%', '50%')">50%</div>
                                     <div onclick="ui.selectImgScale('25%', '25%')">25%</div>
                                 </div>
                             </div>
                             <button onclick="creator.triggerImage()" class="px-3 py-1 text-xs text-gray-300 hover:text-white border-l border-white/10 h-full"><i class="fas fa-image"></i></button>
                        </div>
                        <input type="file" id="inline-image-input" class="hidden" accept="image/*">
                    </div>

                    <div id="editor-content" contenteditable="true" class="glass rounded-b-lg p-4 md:p-8 border-t-0 min-h-[500px] focus:outline-none focus:bg-black/60 transition-colors text-gray-300 font-story leading-loose text-base md:text-lg relative z-0"></div>

                    <div class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4">
                        <div class="text-xs text-gray-500 font-mono">
                            <span id="char-count">0</span> chars | <span id="img-count">0</span> images
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                            <button id="btn-publish" onclick="creator.publish()" class="btn-main px-10 w-full md:w-auto">
                                <span>Manifest</span> <i class="fas fa-skull"></i>
                            </button>
                            <button id="btn-suggest" onclick="creator.submitSuggestion()" class="btn-main px-10 hidden bg-gray-900 border-gray-600 text-gray-400 hover:bg-gray-800 hover:text-white hover:border-white w-full md:w-auto">
                                <span>Submit Suggestion</span> <i class="fas fa-code-branch"></i>
                            </button>
                            <button id="btn-update-story" onclick="creator.update()" class="btn-main px-10 hidden border-green-700 text-green-500 hover:bg-green-900/20 w-full md:w-auto">
                                <span>Update</span> <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIEW: READER -->
            <section id="view-reader" class="view-section hidden animate-in">
                <div class="max-w-4xl mx-auto">
                    <button onclick="router.back()" class="mb-6 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white flex items-center gap-2 transition-colors"><i class="fas fa-arrow-left"></i> The Void</button>

                    <article class="glass rounded-xl overflow-hidden mb-8 border-t border-white/10">
                        <div class="relative h-64 md:h-80 w-full">
                            <img id="reader-cover" class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-700">
                            <div class="absolute inset-0 bg-gradient-to-t from-[#0c0c0c] via-transparent to-transparent"></div>
                            <h1 id="reader-title" class="absolute bottom-6 left-6 right-6 md:bottom-8 md:left-8 md:right-8 font-horror text-3xl md:text-5xl text-red-600 drop-shadow-lg leading-tight">Title</h1>
                        </div>

                        <div class="px-6 py-4 md:px-8 md:py-6 flex justify-between items-center border-b border-white/5 bg-[#0c0c0c]">
                            <div class="flex items-center gap-4 cursor-pointer hover:opacity-80" onclick="profile.openFromReader()">
                                <div class="w-10 h-10 rounded-full bg-gray-800 overflow-hidden border border-gray-700 flex-shrink-0">
                                    <img id="reader-avatar" src="" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <div id="reader-author" class="text-sm font-bold text-gray-200">Author</div>
                                    <div id="reader-cat-tag" class="text-[10px] text-red-500 uppercase tracking-widest font-bold">Category</div>
                                </div>
                            </div>
                            <div class="flex gap-4">
                                <button id="btn-reader-edit" onclick="reader.startEdit()" class="hidden text-red-500 hover:text-red-400 transition-colors" title="Edit Story"><i class="fas fa-pen"></i></button>
                                <button id="btn-reader-suggest" onclick="reader.startSuggestion()" class="text-gray-500 hover:text-red-400 transition-colors" title="Suggest Edit"><i class="fas fa-edit"></i></button>
                                <button onclick="reader.share()" class="text-gray-500 hover:text-white transition-colors" title="Share URL"><i class="fas fa-share-alt"></i></button>
                                <button onclick="reader.toggleLike()" class="group flex items-center gap-2 text-gray-500 hover:text-red-500 transition-colors cursor-pointer" id="btn-like">
                                    <i class="fas fa-heart text-xl group-hover:scale-110 transition-transform" id="like-icon"></i>
                                    <span id="reader-likes" class="font-mono text-sm">0</span>
                                </button>
                                <button onclick="reader.reportOpen()" class="text-gray-600 hover:text-red-800 transition-colors" title="Report"><i class="fas fa-flag"></i></button>
                            </div>
                        </div>

                        <div id="reader-body" class="p-6 md:p-12 font-story text-base md:text-lg text-gray-300 leading-8 bg-[#0c0c0c]"></div>
                        
                        <div id="reader-access-denied" class="hidden p-8 md:p-12 text-center bg-[#0c0c0c]">
                            <i class="fas fa-lock text-5xl text-red-800 mb-4"></i>
                            <h3 class="font-horror text-3xl text-gray-400">Forbidden Scripture</h3>
                            <p class="text-gray-500 mt-2">This story is for Coven coveneers only. Join the Coven to unlock its secrets.</p>
                        </div>

                        <div class="px-8 py-6 bg-black/40 border-t border-white/5 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="text-center md:text-left">
                                <h4 class="font-bold text-gray-400 text-sm">Enjoyed the terror?</h4>
                                <p class="text-xs text-gray-600 mt-1">Reward the creator with credits.</p>
                            </div>
                            <div class="flex flex-wrap items-center justify-center gap-4">
                                <div class="flex gap-2">
                                    <button onclick="reader.creshare(10)" class="btn-secondary text-xs border-green-900 text-green-700 hover:text-green-400 hover:border-green-500"><i class="fas fa-coins mr-1"></i> 10</button>
                                    <button onclick="reader.creshare(50)" class="btn-secondary text-xs border-green-900 text-green-700 hover:text-green-400 hover:border-green-500"><i class="fas fa-coins mr-1"></i> 50</button>
                                </div>
                                <div class="h-6 w-px bg-white/10 hidden md:block"></div>
                                <div class="flex items-center gap-2">
                                    <div class="spin-edit-container">
                                        <button class="spin-btn" onclick="ui.spin('reader-tip-input', -1)">-</button>
                                        <input type="number" id="reader-tip-input" class="spin-input" value="100" min="1">
                                        <button class="spin-btn" onclick="ui.spin('reader-tip-input', 1)">+</button>
                                    </div>
                                    <button onclick="reader.creshareCustom()" class="btn-tip-green">
                                        TIP
                                    </button>
                                </div>
                            </div>
                        </div>
                    </article>

                    <!-- Comments -->
                    <div class="glass p-6 md:p-8 rounded-xl">
                        <h3 class="font-horror text-2xl text-gray-500 mb-6">Echoes</h3>
                        <div class="flex flex-col md:flex-row gap-4 mb-8">
                            <input type="text" id="comment-input" placeholder="Whisper into the dark..." class="input-void w-full">
                            <button onclick="reader.postComment()" class="btn-main py-2 px-6 w-full md:w-auto">Post</button>
                        </div>
                        <div id="comments-list" class="space-y-6"></div>
                        <div id="comments-empty" class="text-center text-gray-700 py-4 hidden">
                            <i class="fas fa-comment-slash text-4xl mb-3"></i>
                            <p class="italic">The whispers are silent for now...</p>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- PROFILE EDITOR MODAL -->
    <div id="modal-profile" class="fixed inset-0 z-[80] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-md p-8 rounded-xl border border-white/10 relative">
            <button onclick="ui.closeProfileEditor()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            <h2 class="font-horror text-3xl text-white mb-6">Identity</h2>
            
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto rounded-full border-2 border-red-900 overflow-hidden relative group cursor-pointer" onclick="document.getElementById('profile-img-upload').click()">
                    <img id="edit-profile-avatar" src="" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/60 hidden group-hover:flex items-center justify-center text-white"><i class="fas fa-camera"></i></div>
                </div>
                <input type="file" id="profile-img-upload" class="hidden" accept="image/*">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase">Username</label>
                    <input type="text" id="edit-username" class="input-void" autocomplete="off">
                    <p id="edit-username-feedback" class="hidden text-xs font-bold mt-1"></p>
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase">Realm Link (Website)</label>
                    <input type="text" id="edit-link" class="input-void" placeholder="https://...">
                </div>
                <div>
                    <label class="text-xs text-gray-500 uppercase">Bio</label>
                    <textarea id="edit-bio" class="input-void h-20 resize-none"></textarea>
                </div>
                <button onclick="profile.save()" class="btn-main w-full" id="btn-profile-save">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- SUGGESTION REVIEW MODAL (REDESIGNED) -->
    <div id="modal-diff" class="fixed inset-0 z-[100] bg-black/95 hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="glass w-[95%] max-w-6xl p-6 md:p-8 rounded-xl border border-green-900/40 relative max-h-[90vh] flex flex-col">
             <h2 class="font-horror text-3xl text-green-500 mb-2">Review Suggestion</h2>
             <p class="text-gray-400 text-sm mb-6">Compare the original version with the suggested changes. Accepting will update the story.</p>
             
             <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden">
                <!-- Original Column -->
                <div class="h-40 md:h-auto overflow-hidden flex flex-col">
                    <h3 class="font-bold text-gray-500 uppercase tracking-widest text-xs mb-2">Original Version</h3>
                    <div id="diff-original" class="flex-grow overflow-y-auto bg-black/50 p-6 rounded border border-white/10 font-story leading-relaxed text-gray-400">
                        <!-- Original content here -->
                    </div>
                </div>
                <!-- New Column -->
                <div class="h-40 md:h-auto overflow-hidden flex flex-col">
                    <h3 class="font-bold text-green-500 uppercase tracking-widest text-xs mb-2">Suggested Version</h3>
                    <div id="diff-new" class="flex-grow overflow-y-auto bg-black/50 p-6 rounded border border-green-900/40 font-story leading-relaxed text-gray-300">
                        <!-- New content here -->
                    </div>
                </div>
            </div>

             <div class="flex justify-end gap-4 mt-6 pt-6 border-t border-white/10">
                 <button id="btn-reject-suggestion" class="btn-secondary text-red-500 border-red-900 hover:bg-red-900/20">Reject</button>
                 <button id="btn-accept-suggestion" class="btn-main border-green-500 text-green-500 hover:bg-green-900/20">Accept & Update</button>
             </div>
        </div>
    </div>


    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, addDoc, deleteDoc, query, orderBy, limit, onSnapshot, increment, serverTimestamp, arrayUnion, arrayRemove, where, writeBatch, getDocs, startAt, endAt } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCf869FUD-h2AUwLeXQtxpCFBNm9BYOIEM", 
            authDomain: "storedstorablestories.firebaseapp.com",
            projectId: "storedstorablestories",
            storageBucket: "storedstorablestories.firebasestorage.app",
            messagingSenderId: "329819137762",
            appId: "1:329819137762:web:6fd48985a42f07368a60bb",
            measurementId: "G-BRGC6T806R"
        };

        const app = initializeApp(firebaseConfig);
        const authService = getAuth(app);
        const db = getFirestore(app);
        const IMGBB_KEY = "b7e9ce509e0ce673e002f8afd73fb71b"; 
        const APP_ID_PATH = "1:329819137762:web:6fd48985a42f07368a60bb"; 
        const CREATOR_ID = "bXFA3reA4veXpQ0tmMDbwSq9oF23";

        // --- CUSTOM TOOLTIP LOGIC ---
        let tooltipTimer;
        const tooltipEl = document.getElementById('custom-tooltip');

        const updateTooltipPos = (e) => {
            const padding = 15;
            const rect = tooltipEl.getBoundingClientRect();
            const winW = window.innerWidth;
            const winH = window.innerHeight;

            let left = e.clientX + padding;
            let top = e.clientY + padding;

            // Check Right Edge
            if (left + rect.width > winW) {
                left = e.clientX - rect.width - padding;
            }

            // Check Bottom Edge
            if (top + rect.height > winH) {
                top = e.clientY - rect.height - padding;
            }

            tooltipEl.style.left = `${left}px`;
            tooltipEl.style.top = `${top}px`;
        };

        document.body.addEventListener('mouseover', (e) => {
            // MOBILE FIX: Disable tooltip on touch devices
            if (window.matchMedia("(pointer: coarse)").matches) return;

            const target = e.target.closest('[title]');
            if (target) {
                const text = target.getAttribute('title');
                if (text) {
                    target.setAttribute('data-original-title', text);
                    target.removeAttribute('title');
                    
                    tooltipTimer = setTimeout(() => {
                        tooltipEl.innerHTML = text;
                        tooltipEl.classList.add('visible');
                        updateTooltipPos(e); // Set initial position
                    }, 1000); // 1 second delay
                }
            }
        });

        document.body.addEventListener('mousemove', (e) => {
            if (tooltipEl.classList.contains('visible')) {
                updateTooltipPos(e);
            }
        });

        document.body.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-original-title]');
            if (target) {
                const text = target.getAttribute('data-original-title');
                target.setAttribute('title', text);
                target.removeAttribute('data-original-title');
                
                clearTimeout(tooltipTimer);
                tooltipEl.classList.remove('visible');
            }
        });


        // --- STATE ---
        const state = {
            user: null,
            profile: null,
            activeStory: null,
            activeProfileId: null,
            activeCommunity: null, 
            activeSuggestion: null,
            previousRoute: null,
            draft: { 
                images: 0, cost: 0, cover: null, category: null, 
                isSuggestion: false, isEdit: false, targetStoryId: null,
                type: 'story',
                communityId: null,
                imgScale: '100%'
            },
            sortBy: 'new',
            filter: null,
            isLiking: false,
            followLock: false,
            feedData: [],
            listeners: [],
            cropper: null,
            signupAvatarBlob: null,
            profileEditAvatarBlob: null,
            userCache: {},
            leaderboard: [],
            usernameValid: false
        };

        // --- HELPERS ---
        const dmp = new diff_match_patch();
        
        // Debounce helper for input events
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const getRank = (credits) => {
            if(credits < 100) return "Neophyte";
            if(credits < 500) return "Acolyte";
            if(credits < 1500) return "Cultist";
            if(credits < 5000) return "Warlock";
            return "Elder God";
        };

        const formatUsername = (uid, username) => {
             if(uid === CREATOR_ID) {
                 return `<span class="text-creator">${username}</span>`;
             }
             return username;
        };

        const timeAgo = (timestamp) => {
            if (!timestamp) return 'Just now';
            const seconds = Math.floor((new Date() - timestamp.toDate()) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        };

        const normalize = (text) => text ? text.toLowerCase().trim() : '';
        
        const abbreviateNumber = (num) => {
            if (num === null || num === undefined) return '0';
            if (num < 1000) return num.toString();
            if (num >= 1000 && num < 1000000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
            return num.toString();
        };

        const getUserProfile = async (uid) => {
            if (!uid) return null;
            if (state.userCache[uid]) {
                return state.userCache[uid];
            }
            try {
                const userSnap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', uid));
                if (userSnap.exists()) {
                    const userData = { id: uid, ...userSnap.data() };
                    state.userCache[uid] = userData;
                    return userData;
                }
            } catch (e) {
                console.error("Failed to fetch user profile:", e);
                return null;
            }
            return null;
        };

        // --- UI CONTROLLER ---
        window.ui = {
            toggleAuth: (mode) => {
                document.getElementById('form-login').classList.toggle('hidden', mode === 'signup');
                document.getElementById('form-signup').classList.toggle('hidden', mode === 'login');
                // Reset validation state on toggle
                state.usernameValid = false;
                const feedback = document.getElementById('signup-username-feedback');
                const input = document.getElementById('signup-name');
                if(feedback) feedback.classList.add('hidden');
                if(input) input.classList.remove('input-error', 'input-success');
            },
            alert: (title, msg) => {
                document.getElementById('alert-title').innerText = title;
                document.getElementById('alert-msg').innerText = msg;
                document.getElementById('modal-alert').classList.remove('hidden');
            },
            closeAlert: () => document.getElementById('modal-alert').classList.add('hidden'),
            confirm: (title, msg, onYes) => {
                document.getElementById('confirm-title').innerText = title;
                document.getElementById('confirm-msg').innerText = msg;
                const modal = document.getElementById('modal-confirm');
                modal.classList.remove('hidden');
                
                document.getElementById('btn-confirm-yes').onclick = () => {
                    modal.classList.add('hidden');
                    if(onYes) onYes();
                };
                
                document.getElementById('btn-confirm-cancel').onclick = () => {
                    modal.classList.add('hidden');
                };
            },
            loading: (show) => {
                const l = document.getElementById('global-loader');
                l.style.opacity = show ? '1' : '0';
                l.style.pointerEvents = show ? 'all' : 'none';
            },
            toggleSelect: (id) => {
                const container = document.getElementById(id);
                const items = container.querySelector('.select-items');
                const selected = container.querySelector('.select-selected');
                
                document.querySelectorAll('.select-items').forEach(i => {
                    if (i !== items) i.classList.remove('select-show');
                });
                 document.querySelectorAll('.select-selected').forEach(s => {
                    if (s !== selected) s.classList.remove('select-active');
                });

                items.classList.toggle('select-show');
                selected.classList.toggle('select-active');
            },
            selectOption: (type, val) => {
                state.draft.category = val;
                document.getElementById(`${type}-selected`).innerText = val;
                document.getElementById(`${type}-selected`).classList.add('select-active');
            },
            selectImgScale: (val, label) => {
                state.draft.imgScale = val;
                document.getElementById('img-scale-selected').innerText = label;
            },
            openProfileEditor: () => {
                document.getElementById('edit-username').value = state.profile.username;
                document.getElementById('edit-bio').value = state.profile.bio || '';
                document.getElementById('edit-link').value = state.profile.link || '';
                document.getElementById('edit-profile-avatar').src = state.profile.avatar;
                
                // Reset edit validation
                const feedback = document.getElementById('edit-username-feedback');
                const input = document.getElementById('edit-username');
                feedback.classList.add('hidden');
                input.classList.remove('input-error', 'input-success');
                state.profileEditAvatarBlob = null;
                
                document.getElementById('modal-profile').classList.remove('hidden');
            },
            closeProfileEditor: () => document.getElementById('modal-profile').classList.add('hidden'),
            spin: (id, delta) => {
                const el = document.getElementById(id);
                let val = parseInt(el.value) || 0;
                val += delta;
                if (id === 'coven-join-fee') {
                    if (val < 0) val = 0;
                    if (val > 50) val = 50;
                } else {
                    if (val < 0) val = 0;
                }
                el.value = val;
            },
            toggleFeeOptions: (isChecked) => {
                const feeOptions = document.getElementById('coven-fee-options');
                if (isChecked) {
                    feeOptions.classList.remove('hidden');
                } else {
                    feeOptions.classList.add('hidden');
                }
            },
            openModal: (id) => {
                document.getElementById(id).classList.remove('hidden');
                document.body.classList.add('modal-open');
            },
            closeModal: (id) => {
                if(id === 'cropper-modal' && state.cropper) {
                    state.cropper.destroy();
                    state.cropper = null;
                }
                document.getElementById(id).classList.add('hidden');
                document.body.classList.remove('modal-open');
            },
            initCropper: (imageSrc, callback) => {
                const image = document.getElementById('cropper-image');
                const modal = document.getElementById('cropper-modal');
                const confirmBtn = document.getElementById('crop-confirm-btn');
                
                image.src = imageSrc;
                ui.openModal('cropper-modal');
                
                if (state.cropper) {
                    state.cropper.destroy();
                }

                state.cropper = new Cropper(image, {
                    aspectRatio: 1 / 1,
                    viewMode: 1,
                    background: false,
                    responsive: true,
                    restore: true,
                    checkOrientation: true,
                    modal: false,
                    guides: true,
                    center: true,
                    highlight: false,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
                
                confirmBtn.onclick = () => {
                    state.cropper.getCroppedCanvas({
                        width: 256,
                        height: 256,
                        minWidth: 128,
                        minHeight: 128,
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high',
                    }).toBlob((blob) => {
                        callback(blob);
                        ui.closeModal('cropper-modal');
                    }, 'image/jpeg', 0.9);
                };
            }
        };

        window.onclick = function(e) {
            if (!e.target.matches('.select-selected') && !e.target.closest('.select-selected')) {
                document.querySelectorAll(".select-items").forEach(i => i.classList.remove('select-show'));
                document.querySelectorAll(".select-selected").forEach(s => s.classList.remove('select-active'));
            }
            if (!e.target.closest('#notif-dropdown') && !e.target.closest('.fa-bell')) {
                document.getElementById('notif-dropdown').classList.add('hidden');
            }
            if (e.target.id === 'modal-confirm') {
                document.getElementById('modal-confirm').classList.add('hidden');
            }
        }

        // --- ROUTER ---
        window.router = {
            getCurrentView: () => {
                const visible = document.querySelector('.view-section:not(.hidden)');
                return visible ? visible.id.replace('view-', '') : 'home';
            },
            go: (view, params = {}) => {
                const currentView = router.getCurrentView();
                
                if (currentView === 'create' && (state.draft.isEdit || state.draft.isSuggestion)) {
                    if (view !== 'create') {
                        creator.reset();
                    }
                }

                const urlParams = new URLSearchParams(window.location.search);
                const currentParams = Object.fromEntries(urlParams.entries());
                
                if(currentView !== view) {
                    state.previousRoute = { view: currentView, params: currentParams };
                }
                
                const url = new URL(window.location);
                url.search = '';
                url.searchParams.set('section', view);
                Object.keys(params).forEach(key => {
                    if(params[key]) url.searchParams.set(key, params[key]);
                });
                window.history.pushState({view, params}, '', url);
                router.render(view, params);
            },
            back: () => {
                 if(window.history.length > 1) {
                    window.history.back();
                } else if(state.previousRoute) {
                    router.go(state.previousRoute.view, state.previousRoute.params);
                } else {
                    router.go('home');
                }
            },
            render: (view, params) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                window.scrollTo(0,0);
                document.title = `Grimoire - ${view.charAt(0).toUpperCase() + view.slice(1)}`;

                if(view === 'home') {
                    if(params.category) {
                        feed.filter(params.category, false);
                    } else {
                        if(document.getElementById('feed-search').value.trim() === '') {
                             state.filter = null;
                             document.getElementById('feed-title').innerText = "Chronicles";
                             loadFeed();
                        }
                    }
                    feed.loadUserSuggestions();
                    feed.loadSponsors();
                }

                if(view === 'explore') {
                    communities.loadAll();
                    explore.loadTrending();
                    explore.loadFresh();
                }
                
                if (view === 'create') {
                    const toggleContainer = document.getElementById('post-type-toggle-container');
                    if (state.draft.communityId) {
                        toggleContainer.classList.remove('hidden');
                    } else {
                        toggleContainer.classList.add('hidden');
                        state.draft.type = 'story';
                        creator.setType('story');
                    }
                }
            },
            handlePopState: (event) => {
                 if (router.getCurrentView() === 'create' && (state.draft.isEdit || state.draft.isSuggestion)) {
                    creator.reset();
                 }

                 const urlParams = new URLSearchParams(window.location.search);
                 const section = urlParams.get('section') || 'home';
                 const params = Object.fromEntries(urlParams.entries());

                 if(params.post) {
                      getDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', params.post)).then(snap => {
                         if(snap.exists()) reader.open(params.post, snap.data(), false);
                     });
                 } else if(params.user) {
                     profile.open(params.user, false);
                 } else if(params.coven) {
                      getDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', params.coven)).then(snap => {
                         if(snap.exists()) communities.open(params.coven, snap.data(), false);
                     });
                 } else {
                     router.render(section, params);
                 }
            }
        };
        window.onpopstate = router.handlePopState;

        // --- AUTH & USERNAME VALIDATION ---
        window.checkUsername = async (username, currentUsername = null) => {
            if (!username) return { valid: false, message: "Username cannot be empty." };
            if (username.length < 3) return { valid: false, message: "Username is too short (min 3)." };
            
            // If checking specifically for profile edit and it matches current, it's valid (yours)
            if (currentUsername && username === currentUsername) {
                return { valid: true, message: "This is your current name." }; 
            }

            // Check DB
            try {
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users'), where('username', '==', username));
                const snap = await getDocs(q);
                if (!snap.empty) return { valid: false, message: "This name is already taken." };
                return { valid: true, message: "This name is available." };
            } catch(e) {
                console.error(e);
                return { valid: false, message: "Error checking name." };
            }
        };

        const handleUsernameInput = async (inputId, feedbackId, currentName = null) => {
            const input = document.getElementById(inputId);
            const feedback = document.getElementById(feedbackId);
            const val = input.value.trim();
            
            feedback.classList.remove('hidden');
            feedback.innerText = "Checking...";
            feedback.className = "text-xs font-bold mt-1 text-gray-500";
            input.classList.remove('input-error', 'input-success');

            const result = await checkUsername(val, currentName);
            
            if (result.valid) {
                state.usernameValid = true;
                feedback.innerText = result.message;
                feedback.className = "text-xs font-bold mt-1 text-success";
                input.classList.add('input-success');
            } else {
                state.usernameValid = false;
                feedback.innerText = result.message;
                feedback.className = "text-xs font-bold mt-1 text-error";
                input.classList.add('input-error');
            }
        };

        window.auth = {
            login: async () => {
                ui.loading(true);
                try {
                    const e = document.getElementById('login-email').value;
                    const p = document.getElementById('login-pass').value;
                    await signInWithEmailAndPassword(authService, e, p);
                } catch(err) { ui.loading(false); ui.alert('Login Failed', err.message); }
            },
            signup: async () => {
                const n = document.getElementById('signup-name').value.trim();
                
                // Pre-check availability
                const check = await checkUsername(n);
                if(!check.valid) return ui.alert("Invalid Name", check.message);

                ui.loading(true);
                const e = document.getElementById('signup-email').value;
                const p = document.getElementById('signup-pass').value;
                const bio = document.getElementById('signup-bio').value;
                const link = document.getElementById('signup-link').value;

                try {
                    let avatarUrl = `https://ui-avatars.com/api/?name=${n.replace(/\s/g, '+')}&background=random`;
                    if (state.signupAvatarBlob) {
                        const uploadedUrl = await creator.upload(state.signupAvatarBlob);
                        if (uploadedUrl) {
                            avatarUrl = uploadedUrl;
                        }
                    }

                    const cred = await createUserWithEmailAndPassword(authService, e, p);
                    
                    await setDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', cred.user.uid), {
                        username: n, email: e, credits: 50,
                        avatar: avatarUrl,
                        bio: bio || '',
                        link: link || '',
                        joined: serverTimestamp(),
                        followers: [], following: [],
                        followerCount: 0,
                        postCount: 0,
                        covenCreatedCount: 0,
                        totalTipped: 0,
                        lastDaily: new Date(0), 
                        likedStories: [] 
                    });
                    await updateProfile(cred.user, { displayName: n });
                    state.signupAvatarBlob = null;
                } catch(err) { ui.loading(false); ui.alert('Signup Failed', err.message); }
            },
            logout: async () => {
                await signOut(authService);
                window.location.reload();
            }
        };

        // --- EXPLORE SEARCH LOGIC ---
        window.explore = {
            loadTrending: async () => {
                const grid = document.getElementById('trending-users-grid');
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users'), orderBy('followerCount', 'desc'));
                onSnapshot(q, (snap) => {
                    grid.innerHTML = '';
                    state.leaderboard = []; 
                    snap.forEach(d => {
                        const u = d.data();
                        state.leaderboard.push({id: d.id, ...u});
                        if(grid.childElementCount < 3) { 
                            const el = document.createElement('div');
                            el.className = 'glass p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-white/5 transition-colors border-l-2 border-red-900/30 hover:border-red-500';
                            el.onclick = () => profile.open(d.id);
                            el.innerHTML = `
                                <div class="w-10 h-10 rounded-full border border-gray-800 overflow-hidden flex-shrink-0">
                                    <img src="${u.avatar}" class="w-full h-full object-cover">
                                </div>
                                <div class="overflow-hidden">
                                    <div class="font-bold text-gray-300 text-sm truncate">${formatUsername(d.id, u.username)}</div>
                                    <div class="text-[10px] text-red-500 uppercase tracking-wider">${getRank(u.credits)}</div>
                                </div>
                            `;
                            grid.appendChild(el);
                        }
                    });
                    if(grid.innerHTML === '') grid.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">No souls have risen yet.</div>';
                });
            },
            loadFresh: async () => {
                const grid = document.getElementById('fresh-users-grid');
                const twentyFourHoursAgo = new Date(Date.now() - (24 * 60 * 60 * 1000));
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users'), where('joined', '>', twentyFourHoursAgo), orderBy('joined', 'desc'), limit(15));
                onSnapshot(q, (snap) => {
                    grid.innerHTML = '';
                    if (snap.empty) { grid.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">No fresh souls detected recently.</div>'; return; }
                    snap.forEach(d => {
                        const u = d.data();
                        const el = document.createElement('div');
                        el.className = 'glass p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-white/5 transition-colors border-l-2 border-gray-700/30 hover:border-white';
                        el.onclick = () => profile.open(d.id);
                        el.innerHTML = `
                            <div class="w-8 h-8 rounded-full border border-gray-800 overflow-hidden flex-shrink-0">
                                <img src="${u.avatar}" class="w-full h-full object-cover">
                            </div>
                            <div class="overflow-hidden">
                                <div class="font-bold text-gray-300 text-sm truncate">${formatUsername(d.id, u.username)}</div>
                                <div class="text-[10px] text-gray-500">${getRank(u.credits)}  ${u.joined ? timeAgo(u.joined) : 'Just now'}</div>
                            </div>
                        `;
                        grid.appendChild(el);
                    });
                });
            },
            search: async (term) => {
                const grid = document.getElementById('communities-grid');
                const emptyEl = document.getElementById('communities-empty');
                grid.innerHTML = '<div class="col-span-2 text-center text-gray-600 text-xs py-12"><i class="fas fa-spinner fa-spin"></i> Searching the abyss...</div>';
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities'), limit(100)); 
                const snap = await getDocs(q);
                
                grid.innerHTML = '';
                let found = false;
                const lowerTerm = normalize(term);

                snap.forEach(d => {
                    const c = d.data();
                    if (normalize(c.name).includes(lowerTerm) || normalize(c.description).includes(lowerTerm)) {
                        found = true;
                        const el = document.createElement('div');
                        el.className = 'glass p-0 rounded-lg overflow-hidden cursor-pointer hover:border-red-900 transition-colors group';
                        el.onclick = () => communities.open(d.id, c);
                        el.innerHTML = `
                            <div class="h-20 bg-cover bg-center grayscale group-hover:grayscale-0 transition-all duration-700" style="background-image: url('${c.coverImage}')"></div>
                            <div class="p-3 relative">
                                <div class="absolute -top-5 right-3 w-8 h-8 rounded-full border-2 border-black overflow-hidden bg-black">
                                    <img src="${c.creatorAvatar}" class="w-full h-full object-cover">
                                </div>
                                <h3 class="font-bold text-red-400 text-sm mb-1 truncate">${c.name}</h3>
                                <div class="text-[10px] text-gray-600 font-mono">
                                    <i class="fas fa-users mr-1"></i> ${c.memberCount} Coveneers
                                </div>
                            </div>
                        `;
                        grid.appendChild(el);
                    }
                });

                if (!found) {
                    emptyEl.classList.remove('hidden');
                } else {
                    emptyEl.classList.add('hidden');
                }
            }
        };

        // --- COMMUNITIES ---
        window.communities = {
            loadAll: () => {
                const grid = document.getElementById('communities-grid');
                const emptyEl = document.getElementById('communities-empty');
                grid.innerHTML = '<div class="col-span-2 text-center text-gray-600 text-xs py-12"><i class="fas fa-spinner fa-spin"></i></div>';
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities'), limit(50));
                
                onSnapshot(q, (snap) => {
                    grid.innerHTML = '';
                    if(snap.empty) {
                        emptyEl.classList.remove('hidden');
                        return;
                    }
                    emptyEl.classList.add('hidden');
                    
                    let covens = [];
                    snap.forEach(d => covens.push({id: d.id, ...d.data()}));
                    covens.sort((a,b) => (b.memberCount || 0) - (a.memberCount || 0));

                    covens.forEach(c => {
                        const el = document.createElement('div');
                        el.className = 'glass p-0 rounded-lg overflow-hidden cursor-pointer hover:border-red-900 transition-colors group';
                        el.onclick = () => communities.open(c.id, c);
                        el.innerHTML = `
                            <div class="h-20 bg-cover bg-center grayscale group-hover:grayscale-0 transition-all duration-700" style="background-image: url('${c.coverImage}')"></div>
                            <div class="p-3 relative">
                                <div class="absolute -top-5 right-3 w-8 h-8 rounded-full border-2 border-black overflow-hidden bg-black">
                                    <img src="${c.creatorAvatar}" class="w-full h-full object-cover">
                                </div>
                                <h3 class="font-bold text-red-400 text-sm mb-1 truncate">${c.name}</h3>
                                <div class="text-[10px] text-gray-600 font-mono">
                                    <i class="fas fa-users mr-1"></i> ${c.memberCount} Coveneers
                                </div>
                            </div>
                        `;
                        grid.appendChild(el);
                    });
                });
            },
            create: async () => { 
                const name = document.getElementById('coven-name').value;
                const desc = document.getElementById('coven-desc').value;
                const fileInput = document.getElementById('coven-img-upload');
                
                let joinFee = 0;
                const feeRequired = document.getElementById('coven-fee-required').checked;
                if (feeRequired) {
                    const selectedFee = document.querySelector('input[name="coven-fee"]:checked');
                    if (selectedFee) {
                        joinFee = parseInt(selectedFee.value);
                    } else {
                        return ui.alert("Incomplete", "Please select a join fee amount.");
                    }
                }
                
                if(!name || !desc || !fileInput.files[0]) return ui.alert("Incomplete", "A Coven needs a Name, Purpose, and Image.");
                if(state.profile.credits < 100) return ui.alert("Poor Soul", "100 Credits required.");

                ui.loading(true);
                try {
                    const coverUrl = await creator.upload(fileInput.files[0]);
                    if(!coverUrl) throw new Error("Image upload failed.");
                    
                    const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);
                    await updateDoc(userRef, { 
                        credits: increment(-100),
                        covenCreatedCount: increment(1)
                    });

                    const covenRef = await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities'), {
                        name,
                        name_lowercase: name.toLowerCase(),
                        description: desc, 
                        coverImage: coverUrl,
                        creatorId: state.user.uid, 
                        creatorName: state.profile.username, 
                        creatorAvatar: state.profile.avatar,
                        createdAt: serverTimestamp(),
                        members: [state.user.uid],
                        roles: { [state.user.uid]: 'Founder' }, 
                        memberCount: 1,
                        pinnedPosts: [],
                        joinFee: joinFee,
                        sponsoredUntil: null
                    });

                    ui.closeModal('modal-create-coven');
                    ui.loading(false);
                    ui.alert("Founded", "The Coven rises.");
                    const newData = { name, description: desc, coverImage: coverUrl, members: [state.user.uid], roles: { [state.user.uid]: 'Founder' }, memberCount: 1, creatorId: state.user.uid, creatorName: state.profile.username, creatorAvatar: state.profile.avatar, pinnedPosts: [], joinFee: joinFee, sponsoredUntil: null };
                    communities.open(covenRef.id, newData);
                } catch(e) { ui.loading(false); ui.alert("Error", e.message); }
            },
            open: (id, data, push = true) => { 
                state.activeCommunity = { id, ...data };
                document.getElementById('coven-hero-name').innerText = data.name;
                document.getElementById('coven-hero-desc').innerText = data.description;
                document.getElementById('coven-hero-img').src = data.coverImage;
                document.getElementById('coven-member-count').innerText = data.memberCount;
                
                getUserProfile(data.creatorId).then(creator => {
                    if (creator) {
                        const isVerified = (creator.followerCount || 0) >= 100;
                        const verifiedBadge = isVerified ? ` <span class="text-red-600 text-xs" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';
                        document.getElementById('coven-creator').innerHTML = formatUsername(data.creatorId, creator.username) + verifiedBadge;
                    } else {
                        document.getElementById('coven-creator').innerText = 'Unknown';
                    }
                });

                const isMember = (data.members || []).includes(state.user.uid);
                const btn = document.getElementById('btn-coven-join');
                btn.innerText = isMember ? "Leave Coven" : "Join Coven";
                btn.className = isMember ? "btn-secondary border-red-900 text-red-500 hover:bg-red-900/20 justify-center" : "btn-main border-red-600 text-red-400 hover:bg-red-900/30 justify-center";

                const sponsorBtn = document.getElementById('btn-coven-sponsor');
                const isCreator = state.user.uid === data.creatorId;
                const isSponsored = data.sponsoredUntil && data.sponsoredUntil.toDate() > new Date();

                if (isCreator) {
                    sponsorBtn.classList.remove('hidden');
                    if (isSponsored) {
                        sponsorBtn.disabled = true;
                        sponsorBtn.innerText = 'Sponsored';
                    } else {
                        sponsorBtn.disabled = false;
                        sponsorBtn.innerText = 'Sponsor (100 CR)';
                    }
                } else {
                    sponsorBtn.classList.add('hidden');
                }

                communities.loadPinned(id, data.pinnedPosts || []);
                communities.loadFeed(id);
                if(push) router.go('community', { coven: id });
                else router.render('community', { coven: id });
            },
            sponsor: async () => {
                if (!state.activeCommunity) return;
                if (state.profile.credits < 100) {
                    return ui.alert("Insufficient Credits", "You need 100 CR to sponsor this Coven.");
                }
                
                ui.confirm(
                    "Sponsor Coven",
                    "Sponsoring your Coven costs 100 CR and will feature it on the main feed for 12 hours. Proceed?",
                    async () => {
                        ui.loading(true);
                        try {
                            const twelveHoursFromNow = new Date(Date.now() + 12 * 60 * 60 * 1000);
                            const batch = writeBatch(db);
                            const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);
                            const covenRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', state.activeCommunity.id);

                            batch.update(userRef, { credits: increment(-100) });
                            batch.update(covenRef, { sponsoredUntil: twelveHoursFromNow });
                            await batch.commit();

                            document.getElementById('btn-coven-sponsor').disabled = true;
                            document.getElementById('btn-coven-sponsor').innerText = 'Sponsored';
                            ui.alert("Success", "Your Coven is now sponsored!");
                        } catch (e) {
                            ui.alert("Error", e.message);
                        } finally {
                            ui.loading(false);
                        }
                    }
                );
            },
            toggleJoin: async () => { 
                if(!state.activeCommunity) return;
                const ref = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', state.activeCommunity.id);
                const isMember = (state.activeCommunity.members || []).includes(state.user.uid);
                const joinFee = state.activeCommunity.joinFee || 0;
                
                const performToggle = async () => {
                    ui.loading(true);
                    try {
                        if (isMember) { // Leaving Coven
                            const newRoles = { ...(state.activeCommunity.roles || {}) };
                            delete newRoles[state.user.uid];
                            await updateDoc(ref, { members: arrayRemove(state.user.uid), memberCount: increment(-1), roles: newRoles });
                            state.activeCommunity.members = state.activeCommunity.members.filter(id => id !== state.user.uid);
                            state.activeCommunity.memberCount--;
                            state.activeCommunity.roles = newRoles;
                        } else { // Joining Coven
                            const batch = writeBatch(db);
                            const newRoles = { ...(state.activeCommunity.roles || {}) };
                            newRoles[state.user.uid] = 'Member';
                            
                            if (joinFee > 0) {
                                // Logic handled in confirm block below, but we double check balance here
                                const selfRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);
                                const creatorRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.activeCommunity.creatorId);
                                
                                batch.update(selfRef, { credits: increment(-joinFee) });
                                batch.update(creatorRef, { credits: increment(joinFee) });
                                notifications.send(state.activeCommunity.creatorId, `${state.profile.username} joined your coven and paid ${joinFee} CR.`, 'credit');
                            }
                            
                            batch.update(ref, { members: arrayUnion(state.user.uid), memberCount: increment(1), roles: newRoles });
                            await batch.commit();
                            
                            if(!state.activeCommunity.members) state.activeCommunity.members = [];
                            state.activeCommunity.members.push(state.user.uid);
                            state.activeCommunity.memberCount++;
                            state.activeCommunity.roles = newRoles;
                        }
                        
                        document.getElementById('coven-member-count').innerText = state.activeCommunity.memberCount;
                        const btn = document.getElementById('btn-coven-join');
                        btn.innerText = !isMember ? "Leave Coven" : "Join Coven";
                        btn.className = !isMember ? "btn-secondary border-red-900 text-red-500 hover:bg-red-900/20 justify-center" : "btn-main border-red-600 text-red-400 hover:bg-red-900/30 justify-center";
                        ui.loading(false);
                    } catch(e) { 
                        ui.loading(false); 
                        ui.alert("Error Joining", e.message); 
                    }
                };

                if (!isMember && joinFee > 0) {
                     if (state.profile.credits < joinFee) {
                        return ui.alert("Insufficient Credits", `You need ${joinFee} CR to join this Coven.`);
                    }
                    ui.confirm(
                        "Join Fee Required",
                        `This Coven requires a payment of ${joinFee} CR to join. The funds will be sent to the Coven's creator. Do you agree?`,
                        performToggle
                    );
                } else {
                    performToggle();
                }
            },
            loadFeed: (covenId) => {
                const grid = document.getElementById('coven-feed-grid');
                const emptyEl = document.getElementById('coven-feed-empty');
                grid.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"><i class="fas fa-spinner fa-spin"></i> Summoning echoes...</div>';
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories'), where('communityId', '==', covenId), limit(50));
                
                onSnapshot(q, async (snap) => {
                    if(snap.empty) {
                        grid.innerHTML = '';
                        emptyEl.classList.remove('hidden');
                        return;
                    }
                    emptyEl.classList.add('hidden');

                    let posts = [];
                    snap.forEach(d => posts.push({id: d.id, ...d.data()}));
                    posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    const authorIds = [...new Set(posts.map(p => p.authorId))];
                    await Promise.all(authorIds.map(id => getUserProfile(id)));

                    grid.innerHTML = ''; 
                    posts.forEach(data => {
                        const author = state.userCache[data.authorId];
                        if (!author) return;
                        grid.appendChild(communities.createPostCard(data, author));
                    });
                });
            },
            createPostCard: (data, author) => {
                const isThread = data.type === 'thread';
                const el = document.createElement('div');
                const likeIconClass = (state.profile.likedStories || []).includes(data.id) ? 'text-red-600' : 'text-gray-500';
                const postedTime = data.createdAt ? timeAgo(data.createdAt) : 'Just now';
                const isVerified = (author.followerCount || 0) >= 100;
                const verifiedBadge = isVerified ? ` <span class="text-red-600" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';
                const isMembersOnly = data.membersOnly;

                const selfRole = communities.getSelfRole();
                const canManage = selfRole === 'Founder' || selfRole === 'Elder';
                const pinIconClass = (state.activeCommunity.pinnedPosts || []).includes(data.id) ? 'fa-thumbtack text-yellow-400' : 'fa-thumbtack text-gray-600';
                const managementControls = canManage ? `
                    <button onclick="event.stopPropagation(); communities.togglePin('${data.id}')" class="hover:text-yellow-400 transition-colors" title="Pin Post">
                        <i class="fas ${pinIconClass}"></i>
                    </button>
                ` : '';

                const commonClickHandler = () => {
                    if (isMembersOnly && !communities.isMember()) {
                        ui.alert('Access Denied', 'This content is for Coven coveneers only.');
                        return;
                    }
                    if (isThread) threadView.open(data.id, data);
                    else reader.open(data.id, data);
                };

                const formattedAuthorName = formatUsername(author.id, author.username);

                if (isThread) {
                    el.className = 'glass rounded-lg p-3 thread-card flex flex-col coven-post-card cursor-pointer'; 
                    el.onclick = commonClickHandler;
                    el.innerHTML = `
                        <div class="flex items-start justify-between">
                            <div class="flex items-center gap-3 mb-3">
                                <img src="${author.avatar}" class="w-8 h-8 rounded-full bg-gray-800 border border-white/10">
                                <div>
                                    <div class="text-xs font-bold text-gray-400">${formattedAuthorName}${verifiedBadge}</div>
                                    <div class="text-[10px] text-gray-600 font-mono">THREAD  ${postedTime}</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 text-gray-500">${isMembersOnly ? `<i class="fas fa-lock text-xs text-yellow-600" title="Coveneers Only"></i>` : ''} ${managementControls}</div>
                        </div>
                        <h4 class="font-bold text-lg text-gray-200 mb-2 hover:text-red-400">${data.title}</h4>
                        <p class="text-sm text-gray-500 line-clamp-3 mb-4 font-story">${data.description}</p>
                        <div class="flex items-center gap-4 text-xs text-gray-600 font-bold mt-auto pt-3 border-t border-white/5">
                             <button onclick="event.stopPropagation(); reader.toggleLike('${data.id}')" class="flex items-center gap-1 group">
                                <i class="fas fa-heart ${likeIconClass} group-hover:text-red-500 transition-colors" id="thread-like-icon-${data.id}"></i> 
                                <span>${data.likes || 0}</span>
                             </button>
                             <span class="flex items-center gap-1"><i class="fas fa-comment-alt mr-1"></i> ${data.commentCount || 0}</span>
                        </div>
                    `;
                } else {
                    el.className = 'glass rounded-lg p-0 overflow-hidden story-card coven-post-card cursor-pointer';
                    el.onclick = commonClickHandler;
                    el.innerHTML = `
                        <div class="h-40 bg-cover bg-center grayscale group-hover:grayscale-0 transition-all duration-500" style="background-image: url('${data.coverImage}')">
                            <div class="w-full h-full bg-black/30 group-hover:bg-transparent transition-all duration-500"></div>
                        </div>
                        <div class="p-4 border-t border-white/5 relative bg-[#0c0c0c]">
                             <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-gray-100 truncate font-story group-hover:text-red-500 transition-colors pr-4">${data.title}</h3>
                                <div class="text-right flex-shrink-0">
                                    <div class="bg-red-900 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg uppercase tracking-widest">
                                        ${data.category || 'Unknown'}
                                    </div>
                                    ${isMembersOnly ? `<div class="text-yellow-600 mt-1 text-right" title="Coveneers Only"><i class="fas fa-lock text-xs"></i></div>` : ''}
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 line-clamp-2 mb-3 leading-relaxed">${data.description}</p>
                            <div class="flex justify-between items-center text-xs text-gray-600 border-t border-white/5 pt-3">
                                <span class="flex items-center gap-1"><img src="${author.avatar}" class="w-4 h-4 rounded-full"> ${formattedAuthorName}${verifiedBadge}</span>
                                <div class="flex items-center gap-3">
                                    ${managementControls}
                                    <span class="flex items-center gap-1">
                                        <i class="fas fa-heart ${likeIconClass}" id="coven-story-like-icon-${data.id}"></i> 
                                        ${data.likes || 0}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return el;
            },
            triggerPost: () => {
                if(!state.activeCommunity) return;
                creator.reset();
                state.draft.communityId = state.activeCommunity.id;
                state.draft.type = 'story'; // Default to story when opening coven post
                router.go('create');
                document.getElementById('create-header-title').innerText = `Whisper to ${state.activeCommunity.name}`;
                document.getElementById('coven-options').classList.remove('hidden');
                document.getElementById('post-type-toggle-container').classList.remove('hidden');
            },
            showMembers: async () => {
                if (!state.activeCommunity) return;
                const listEl = document.getElementById('coven-members-list');
                listEl.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"><i class="fas fa-spinner fa-spin"></i> Loading coveneers...</div>';
                ui.openModal('modal-coven-members');

                const memberIds = state.activeCommunity.members || [];
                const roles = state.activeCommunity.roles || {};
                const memberPromises = memberIds.map(uid => getUserProfile(uid));
                const memberProfiles = await Promise.all(memberPromises);

                listEl.innerHTML = '';
                const selfRole = communities.getSelfRole();
                const canManage = selfRole === 'Founder' || selfRole === 'Elder';

                memberProfiles.filter(p => p).forEach(user => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between p-2 rounded';
                    const userRole = roles[user.id] || 'Member';

                    let actionsHtml = '';
                    // Only the Founder can manage roles, and not on themselves.
                    if (selfRole === 'Founder' && user.id !== state.user.uid) {
                        actionsHtml = '<div class="flex items-center gap-2">';
                        if (userRole === 'Member') {
                            actionsHtml += `<button onclick="communities.manageRole('${user.id}', 'Elder')" class="text-[10px] font-bold uppercase border border-yellow-800 text-yellow-500 px-2 py-0.5 rounded hover:bg-yellow-900/40">Make Elder</button>`;
                        } else if (userRole === 'Elder') {
                            actionsHtml += `<button onclick="communities.manageRole('${user.id}', 'Member')" class="text-[10px] font-bold uppercase border border-gray-600 text-gray-400 px-2 py-0.5 rounded hover:bg-gray-700/40">Make Coveneer</button>`;
                        }
                        
                        // Kick button for anyone who isn't the founder.
                        actionsHtml += `<button onclick="communities.manageRole('${user.id}', 'Kick')" class="text-[10px] font-bold uppercase border border-red-800 text-red-500 px-2 py-0.5 rounded hover:bg-red-900/40">Kick</button>`;
                        
                        actionsHtml += '</div>';
                    }

                    el.innerHTML = `
                        <div class="flex items-center gap-3 cursor-pointer" onclick="ui.closeModal('modal-coven-members'); profile.open('${user.id}')">
                            <img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover border border-gray-700">
                            <div>
                                <span class="font-bold text-sm text-gray-300">${formatUsername(user.id, user.username)}</span>
                                <div class="text-[10px] font-bold uppercase tracking-wider ${userRole === 'Founder' ? 'text-red-500' : userRole === 'Elder' ? 'text-yellow-500' : 'text-gray-500'}">${userRole} (${getRank(user.credits)})</div>
                            </div>
                        </div>
                        ${actionsHtml}
                    `;
                    listEl.appendChild(el);
                });
                if (memberProfiles.length === 0) listEl.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">No coveneers yet.</div>';
            },
            manageRole: async (targetUid, action) => {
                const covenRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', state.activeCommunity.id);
                const newRoles = { ...state.activeCommunity.roles };
                let notifMessage = '';

                if (action === 'Kick') {
                    delete newRoles[targetUid];
                    await updateDoc(covenRef, {
                        roles: newRoles,
                        members: arrayRemove(targetUid),
                        memberCount: increment(-1)
                    });
                     notifMessage = `You have been kicked from the coven '${state.activeCommunity.name}' by ${state.profile.username}.`;
                } else {
                    newRoles[targetUid] = action;
                    await updateDoc(covenRef, { roles: newRoles });
                    if(action === 'Elder') {
                        notifMessage = `You were promoted to Elder in '${state.activeCommunity.name}' by ${state.profile.username}.`;
                    } else {
                        notifMessage = `Your role was changed to Member in '${state.activeCommunity.name}' by ${state.profile.username}.`;
                    }
                }
                
                // Send notification
                if (notifMessage) {
                    notifications.send(targetUid, notifMessage, 'coven_role');
                }

                const snap = await getDoc(covenRef);
                state.activeCommunity = { id: snap.id, ...snap.data() };
                communities.showMembers();
            },
            getSelfRole: () => {
                if (!state.activeCommunity || !state.activeCommunity.roles) return null;
                return state.activeCommunity.roles[state.user.uid] || null;
            },
            isMember: () => {
                if (!state.user || !state.activeCommunity || !state.activeCommunity.members) return false;
                return state.activeCommunity.members.includes(state.user.uid);
            },
            togglePin: async (storyId) => {
                const covenRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', state.activeCommunity.id);
                const isPinned = (state.activeCommunity.pinnedPosts || []).includes(storyId);
                const operation = isPinned ? arrayRemove(storyId) : arrayUnion(storyId);
                await updateDoc(covenRef, { pinnedPosts: operation });

                if (isPinned) {
                    state.activeCommunity.pinnedPosts = state.activeCommunity.pinnedPosts.filter(id => id !== storyId);
                } else {
                    if (!state.activeCommunity.pinnedPosts) state.activeCommunity.pinnedPosts = [];
                    state.activeCommunity.pinnedPosts.push(storyId);
                }
                communities.loadPinned(state.activeCommunity.id, state.activeCommunity.pinnedPosts);
                communities.loadFeed(state.activeCommunity.id);
            },
            loadPinned: async (covenId, pinnedIds) => {
                const container = document.getElementById('coven-pinned-section');
                const grid = document.getElementById('coven-pinned-grid');
                if (!pinnedIds || pinnedIds.length === 0) {
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');
                grid.innerHTML = '';
                
                const postPromises = pinnedIds.map(id => getDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', id)));
                const postSnaps = await Promise.all(postPromises);
                
                const authorIds = new Set();
                const posts = postSnaps.map(snap => {
                    if (snap.exists()) {
                        const data = { id: snap.id, ...snap.data() };
                        authorIds.add(data.authorId);
                        return data;
                    }
                    return null;
                }).filter(p => p);

                await Promise.all(Array.from(authorIds).map(id => getUserProfile(id)));

                posts.forEach(post => {
                    const author = state.userCache[post.authorId];
                    if (author) grid.appendChild(communities.createPostCard(post, author));
                });
            }
        };

        // --- THREAD VIEW ---
        window.threadView = {
            open: async (id, data) => { 
                state.activeStory = { id, ...data }; 
                const author = await getUserProfile(data.authorId);
                if (!author) return;

                document.getElementById('thread-my-avatar').src = state.profile.avatar;
                
                const contentDiv = document.getElementById('thread-main-content');
                const likeIconClass = (state.profile.likedStories || []).includes(data.id) ? 'text-red-600' : 'text-gray-500';
                const postedTime = data.createdAt ? timeAgo(data.createdAt) : 'Just now';
                const isVerified = (author.followerCount || 0) >= 100;
                const verifiedBadge = isVerified ? ` <span class="text-red-600" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';


                contentDiv.innerHTML = `
                    <div class="bg-[#0a0a0a] p-5 rounded-lg border border-white/10 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <img src="${author.avatar}" class="w-10 h-10 rounded-full border border-gray-700 flex-shrink-0">
                            <div>
                                <div class="font-bold text-red-400 text-sm">${formatUsername(author.id, author.username)}${verifiedBadge}</div>
                                <div class="text-[10px] text-gray-600">${postedTime}</div>
                            </div>
                        </div>
                        <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 font-story leading-tight">${data.title}</h2>
                        <div class="text-gray-300 text-base md:text-lg leading-loose font-story">${data.content}</div>
                        
                        <div class="flex gap-4 text-xs font-bold pt-4 mt-4 border-t border-white/5">
                             <button onclick="reader.toggleLike()" class="flex items-center gap-2 hover:text-red-500 transition-colors group">
                                <i class="fas fa-heart text-lg ${likeIconClass}" id="like-icon-thread"></i> 
                                <span id="reader-likes-thread">${data.likes || 0} Likes</span>
                             </button>
                             <button onclick="reader.share()" class="flex items-center gap-2 text-gray-500 hover:text-white transition-colors">
                                <i class="fas fa-share-alt text-lg"></i><span>Share</span>
                             </button>
                        </div>
                    </div>
                `;
                
                threadView.loadComments(id);
                ui.openModal('modal-thread');
            },
            close: () => {
                ui.closeModal('modal-thread');
                state.activeStory = null;
            },
            loadComments: (storyId) => { 
                const list = document.getElementById('thread-comments-list');
                const badge = document.getElementById('thread-comment-count-badge');
                list.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"><i class="fas fa-spinner fa-spin"></i> Loading echoes...</div>';
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', storyId, 'comments'), orderBy('createdAt', 'asc'));
                onSnapshot(q, snap => {
                    list.innerHTML = '';
                    badge.innerText = snap.size;

                    if (snap.empty) {
                        list.innerHTML = `
                            <div class="text-center text-gray-700 italic text-xs pt-10">
                                <i class="fas fa-comment-slash text-4xl mb-3"></i>
                                <p>Be the first to whisper into this silence...</p>
                            </div>
                        `;
                        return;
                    }

                    const comments = [];
                    snap.forEach(doc => comments.push({ id: doc.id, ...doc.data() }));
                    const commentTree = comments.filter(c => !c.parentId);
                    commentTree.forEach(comment => {
                        const el = threadView.createCommentElement(comment, comments);
                        list.appendChild(el);
                    });
                });
            },
            createCommentElement: (comment, allComments) => { 
                const el = document.createElement('div');
                el.className = 'flex gap-3';
                const commentTime = comment.createdAt ? timeAgo(comment.createdAt) : 'Just now';
                const formattedCommentAuthor = formatUsername(comment.authorId, comment.author);

                el.innerHTML = `
                    <div class="flex-shrink-0">
                        <img src="${comment.authorAvatar || `https://ui-avatars.com/api/?name=${comment.author.replace(/\s/g, '+')}&background=random`}" class="w-8 h-8 rounded-full object-cover border border-gray-700">
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="bg-gray-900/50 p-3 rounded-lg border border-white/5">
                            <div class="flex items-center gap-2 text-xs mb-2">
                                <span class="font-bold text-red-400">${formattedCommentAuthor}</span>
                                <span class="text-gray-600"> ${commentTime}</span>
                            </div>
                            <p class="text-sm text-gray-300 leading-relaxed font-story break-words">${comment.text}</p>
                        </div>
                        <div class="mt-2 text-xs">
                            <button class="font-bold text-gray-500 hover:text-white" onclick="threadView.showReplyBox('${comment.id}', '${comment.author}')">Reply</button>
                        </div>
                        <div id="reply-box-${comment.id}" class="hidden mt-3 ml-4"></div>
                        <div id="children-${comment.id}" class="mt-4 space-y-4 border-l-2 border-white/10 pl-4"></div>
                    </div>
                `;

                const childrenContainer = el.querySelector(`#children-${comment.id}`);
                const children = allComments.filter(c => c.parentId === comment.id);
                children.forEach(child => {
                    const childEl = threadView.createCommentElement(child, allComments);
                    childrenContainer.appendChild(childEl);
                });

                return el;
            },
            showReplyBox: (commentId, authorName) => {
                document.querySelectorAll('[id^=reply-box-]').forEach(box => box.innerHTML = '');
                const container = document.getElementById(`reply-box-${commentId}`);
                container.classList.remove('hidden');
                container.innerHTML = `
                    <textarea id="reply-input-${commentId}" class="w-full bg-[#0a0a0a] border border-white/10 rounded p-2 text-gray-300 placeholder-gray-700 h-16 resize-none font-story text-sm focus:border-red-900 transition-all outline-none" placeholder="Replying to ${authorName}..."></textarea>
                    <div class="flex justify-end gap-2 mt-2">
                        <button onclick="document.getElementById('reply-box-${commentId}').classList.add('hidden')" class="px-3 py-1 bg-transparent text-gray-500 text-xs font-bold uppercase rounded">Cancel</button>
                        <button onclick="threadView.postReply('${commentId}')" class="px-3 py-1 bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white text-xs font-bold uppercase rounded">Submit</button>
                    </div>
                `;
                 document.getElementById(`reply-input-${commentId}`).focus();
            },
            postReply: async (parentId = null) => { 
                 const inputId = parentId ? `reply-input-${parentId}` : 'thread-reply-input';
                 const input = document.getElementById(inputId);
                 const txt = input.value;
                 if(!txt) return;

                 const commentData = {
                    text: txt, 
                    author: state.profile.username, 
                    authorId: state.user.uid, 
                    authorAvatar: state.profile.avatar,
                    createdAt: serverTimestamp(),
                    parentId: parentId || null
                 };
                 
                 try {
                     await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.activeStory.id, 'comments'), commentData);
                     await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.activeStory.id), {
                        commentCount: increment(1)
                     });
                     input.value = '';
                     if(parentId) document.getElementById(`reply-box-${parentId}`).classList.add('hidden');
                 } catch(e) { ui.alert("Error", e.message); console.error(e); }
            }
        };


        // --- CREATOR & SUGGESTIONS ---
        window.creator = { 
            startNewStory: () => {
                creator.reset();
                router.go('create');
            },
            reset: () => {
                state.draft = { 
                    images: 0, cost: 0, cover: null, category: null, 
                    isSuggestion: false, isEdit: false, targetStoryId: null,
                    type: 'story',
                    communityId: null,
                    imgScale: '100%'
                };
                document.getElementById('create-title').value = '';
                document.getElementById('create-desc').value = '';
                document.getElementById('editor-content').innerHTML = '';
                document.getElementById('create-tags').value = '';
                document.getElementById('create-title').disabled = false;
                document.getElementById('create-desc').disabled = false;
                document.getElementById('create-tags').disabled = false;
                document.getElementById('cat-dropdown').style.pointerEvents = 'auto';
                document.getElementById('cover-upload-container').style.pointerEvents = 'auto';
                document.getElementById('coven-options').classList.add('hidden');
                document.getElementById('create-members-only').checked = false;
                
                document.getElementById('post-type-toggle-container').classList.add('hidden');
                creator.setType('story');
                document.getElementById('cover-preview').classList.add('hidden');
                document.getElementById('cover-preview').src = '';
                document.getElementById('cat-selected').innerText = 'Select Realm';
                document.getElementById('cat-selected').classList.remove('select-active');
                
                document.getElementById('create-header-title').innerText = "Manifest Nightmare";
                document.getElementById('create-header-sub').innerText = "Authentic Horror Only. No AI.";
                document.getElementById('btn-publish').classList.remove('hidden');
                document.getElementById('btn-suggest').classList.add('hidden');
                document.getElementById('btn-update-story').classList.add('hidden');

                creator.recalc();
            },
            setType: (type) => {
                state.draft.type = type;
                const btnStory = document.getElementById('type-story');
                const btnThread = document.getElementById('type-thread');
                const coverContainer = document.getElementById('cover-upload-container');
                const inputsContainer = document.getElementById('create-form-left');
                
                if(type === 'story') {
                    btnStory.className = "px-4 py-1 text-xs uppercase font-bold rounded bg-red-900/50 text-white border border-red-700";
                    btnThread.className = "px-4 py-1 text-xs uppercase font-bold rounded text-gray-500 hover:text-white";
                    coverContainer.classList.remove('hidden');
                    if(inputsContainer) {
                        inputsContainer.classList.remove('md:col-span-3');
                        inputsContainer.classList.add('md:col-span-2');
                    }
                } else {
                    btnThread.className = "px-4 py-1 text-xs uppercase font-bold rounded bg-white/10 text-white border border-white/20";
                    btnStory.className = "px-4 py-1 text-xs uppercase font-bold rounded text-gray-500 hover:text-white";
                    coverContainer.classList.add('hidden');
                    if(inputsContainer) {
                        inputsContainer.classList.remove('md:col-span-2');
                        inputsContainer.classList.add('md:col-span-3');
                    }
                }
                creator.recalc();
            },
            triggerImage: () => document.getElementById('inline-image-input').click(),
            upload: async (file) => {
                if(file.size > 1000000) { ui.alert("Too Large", "Max 1MB per image"); return null; }
                const fd = new FormData(); fd.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, { method: 'POST', body: fd });
                    const d = await res.json();
                    return d.success ? d.data.url : null;
                } catch { return null; }
            },
            recalc: () => {
                const len = document.getElementById('editor-content').innerText.length;
                document.getElementById('char-count').innerText = len;
                document.getElementById('img-count').innerText = state.draft.images;
                
                let cost = 0;
                if (!state.draft.isEdit && !state.draft.isSuggestion) {
                    if(state.draft.type === 'story') {
                        cost = len < 50 ? 0 : 25 + Math.ceil(len / 20) + (state.draft.images * 10);
                    } else {
                        cost = len < 10 ? 0 : 5 + Math.ceil(len / 50);
                    }
                }
                
                state.draft.cost = cost;
                document.getElementById('create-cost').innerText = cost + " CR";
            },
            publish: async () => { 
                const title = document.getElementById('create-title').value;
                const desc = document.getElementById('create-desc').value;
                const content = document.getElementById('editor-content').innerHTML;
                const text = document.getElementById('editor-content').innerText;
                const isMembersOnly = document.getElementById('create-members-only').checked;

                if(!title || text.length < 10) return ui.alert("Incomplete", "Your nightmare needs a title and some content.");
                if(state.draft.type === 'story' && !state.draft.cover) return ui.alert("Missing", "A story requires a cover image. Please upload one.");
                if(state.draft.type === 'story' && !state.draft.category) return ui.alert("Missing", "Please select a Realm (category) for your story.");
                if(state.profile.credits < state.draft.cost) return ui.alert("Insufficient Funds", "You need more credits.");

                ui.loading(true);
                try {
                    const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);
                    let finalCost = state.draft.cost;
                    
                    if (state.profile.postCount === 0) {
                        await updateDoc(userRef, { credits: increment(25) });
                        notifications.send(state.user.uid, `Bonus! +25 CR for your first story.`, 'credit');
                    }

                    await updateDoc(userRef, { 
                        credits: increment(-finalCost),
                        postCount: increment(1)
                    });
                    
                    const tagsInput = document.getElementById('create-tags').value;
                    const tags = tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag.length > 0);
                    
                    const descKeywords = desc.toLowerCase().split(/\s+/).slice(0, 15);
                    const keywords = [...new Set([
                        ...title.toLowerCase().split(/\s+/), 
                        ...tags,
                        ...descKeywords
                    ])];

                    if(state.draft.category) keywords.push(state.draft.category.toLowerCase());

                    await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories'), {
                        title, 
                        category: state.draft.type === 'thread' ? 'Thread' : state.draft.category, 
                        description: desc || text.substring(0, 100), 
                        content,
                        coverImage: state.draft.cover || 'https://via.placeholder.com/800x400/000?text=Void', 
                        authorId: state.user.uid,
                        createdAt: serverTimestamp(), likes: 0, likedBy: [], keywords, tags,
                        type: state.draft.type,
                        communityId: state.draft.communityId || null,
                        membersOnly: isMembersOnly,
                        commentCount: 0,
                        milestonesReached: []
                    });
                    
                    ui.loading(false);
                    if(state.draft.communityId) {
                        router.go('community', { coven: state.draft.communityId }); 
                    } else {
                        router.go('home');
                    }
                    ui.alert('Success', 'Manifested.');
                    creator.reset();
                } catch(e) { ui.loading(false); ui.alert('Error', e.message); }
            },
            submitSuggestion: async () => { 
                const content = document.getElementById('editor-content').innerHTML;
                ui.loading(true);
                try {
                    const docRef = await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'suggestions'), {
                         storyId: state.draft.targetStoryId,
                         originalContent: state.activeStory.content,
                         newContent: content,
                         suggesterId: state.user.uid,
                         suggesterName: state.profile.username,
                         status: 'pending',
                         createdAt: serverTimestamp()
                    });
                    await notifications.send(state.activeStory.authorId, `Edits suggested for "${state.activeStory.title}"`, 'suggestion', { suggestionId: docRef.id });
                    ui.loading(false);
                    router.go('home');
                    ui.alert('Sent', 'The author will review your edits.');
                    creator.reset(); 
                } catch(e) { ui.loading(false); ui.alert('Error', e.message); }
            },
            update: async () => { 
                const title = document.getElementById('create-title').value;
                const desc = document.getElementById('create-desc').value;
                const content = document.getElementById('editor-content').innerHTML;
                
                if(!state.draft.targetStoryId) return;

                ui.loading(true);
                try {
                    await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.draft.targetStoryId), {
                        title, description: desc, content, 
                        coverImage: state.draft.cover || state.activeStory.coverImage,
                        category: state.draft.category || state.activeStory.category,
                        updatedAt: serverTimestamp()
                    });
                    ui.loading(false);
                    router.go('reader', { post: state.draft.targetStoryId });
                    ui.alert("Rewritten", "History has been altered.");
                    creator.reset(); 
                } catch(e) { ui.loading(false); ui.alert("Error", e.message); }
            }
        };
        
        window.suggestions = { 
            openReview: async (sugId, notifId = null) => {
                ui.loading(true);
                const snap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'suggestions', sugId));
                if(!snap.exists()) { ui.loading(false); return; }
                state.activeSuggestion = { id: snap.id, ...snap.data(), notifId: notifId };
                
                document.getElementById('diff-original').innerHTML = state.activeSuggestion.originalContent;
                document.getElementById('diff-new').innerHTML = state.activeSuggestion.newContent;
                
                document.getElementById('btn-accept-suggestion').onclick = () => suggestions.accept();
                document.getElementById('btn-reject-suggestion').onclick = () => suggestions.reject();
                ui.openModal('modal-diff');
                ui.loading(false);
            },
            accept: async () => {
                if(!state.activeSuggestion) return;
                ui.loading(true);
                try {
                    const batch = writeBatch(db);
                    const storyRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.activeSuggestion.storyId);
                    const suggestionRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'suggestions', state.activeSuggestion.id);
                    const suggesterRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.activeSuggestion.suggesterId);

                    if (state.activeSuggestion.notifId) {
                        const notifRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid, 'notifications', state.activeSuggestion.notifId);
                        batch.delete(notifRef);
                    }

                    batch.update(storyRef, { content: state.activeSuggestion.newContent });
                    batch.delete(suggestionRef);
                    batch.update(suggesterRef, { credits: increment(20) });

                    await batch.commit();
                    
                    const storySnap = await getDoc(storyRef);
                    const storyTitle = storySnap.exists() ? storySnap.data().title : "your story";
                    await notifications.send(state.activeSuggestion.suggesterId, `Your edit for "${storyTitle}" was accepted! +20 CR`, 'credit');
                    
                    ui.closeModal('modal-diff');
                    ui.alert("Accepted", "Story updated and creator rewarded.");

                } catch (e) {
                    console.error("Error accepting suggestion:", e);
                    ui.alert("Error", `Could not accept suggestion: ${e.message}`);
                } finally {
                    ui.loading(false);
                }
            },
            reject: async () => {
                if(!state.activeSuggestion) return;
                ui.loading(true);
                try {
                    if (state.activeSuggestion.notifId) {
                        await deleteDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid, 'notifications', state.activeSuggestion.notifId));
                    }
                    await deleteDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'suggestions', state.activeSuggestion.id));
                    ui.closeModal('modal-diff');
                    ui.alert("Rejected", "The suggestion has been discarded.");
                } catch (e) {
                     console.error("Error rejecting suggestion:", e);
                     ui.alert("Error", `Could not reject suggestion: ${e.message}`);
                } finally {
                    ui.loading(false);
                }
            }
        };

        // --- FEED & SEARCH REWRITE ---
        window.feed = { 
            sort: (type) => {
                state.sortBy = type;
                state.filter = null; 
                document.getElementById('sort-new').classList.toggle('bg-white/5', type === 'new');
                document.getElementById('sort-hot').classList.toggle('bg-white/5', type === 'hot');
                document.getElementById('sort-following').classList.toggle('bg-white/5', type === 'following');
                loadFeed();
            },
            filter: (cat, updateRouter = true) => {
                state.filter = cat;
                document.getElementById('feed-title').innerText = `Realm: ${cat}`;
                if(updateRouter) router.go('home', { category: cat });
                loadFeed();
            },
            render: (list) => {
                const container = document.getElementById('feed-grid');
                const emptyEl = document.getElementById('feed-empty');
                
                container.innerHTML = '';
                
                if(list.length === 0) {
                   container.classList.add('hidden');
                   emptyEl.classList.remove('hidden');
                } else {
                   container.classList.remove('hidden');
                   emptyEl.classList.add('hidden');
                }
                
                list.forEach(item => {
                    if (item.type === 'user-profile') {
                        container.appendChild(feed.createUserCard(item.data));
                    } else { 
                        const card = feed.createStoryCard(item);
                        if (card) container.appendChild(card);
                    }
                });
            },
            createStoryCard: (data) => {
                const author = state.userCache[data.authorId];
                if (!author) return null;

                const el = document.createElement('div');
                const isThread = data.type === 'thread';
                const hasLiked = (state.profile.likedStories || []).includes(data.id);
                const likeIconClass = hasLiked ? 'text-red-600' : 'text-red-900';
                const postedTime = data.createdAt ? timeAgo(data.createdAt) : 'Just now';
                const isVerified = (author.followerCount || 0) >= 100;
                const verifiedBadge = isVerified ? ` <span class="text-red-600" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';
                const formattedAuthorName = formatUsername(author.id, author.username);


                if (isThread) {
                    el.className = 'glass p-6 rounded-lg cursor-pointer relative group bg-gray-950 border border-white/10 hover:border-red-900 transition-all';
                    el.onclick = () => threadView.open(data.id, data);
                    el.innerHTML = `
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div class="flex items-center gap-3">
                                <img src="${author.avatar}" class="w-8 h-8 rounded-full bg-gray-800 border border-white/10 flex-shrink-0">
                                <div>
                                    <div class="text-xs font-bold text-gray-400 group-hover:text-red-500 transition-colors">${formattedAuthorName}${verifiedBadge}</div>
                                    <div class="text-[10px] text-gray-600 font-mono">THREAD  ${postedTime}</div>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); reader.toggleLike('${data.id}')" class="text-gray-500 hover:text-red-500 transition-colors">
                                <i class="fas fa-heart ${likeIconClass} text-lg" id="feed-thread-like-icon-${data.id}"></i>
                            </button>
                        </div>
                        <h3 class="font-bold text-xl text-gray-200 mb-3 group-hover:text-red-400 transition-colors font-story leading-snug relative z-10">${data.title}</h3>
                        <p class="text-sm text-gray-500 line-clamp-2 mb-4 relative z-10">${data.description}</p>
                        <div class="relative z-10 pt-4 border-t border-white/5 flex items-center gap-4 text-xs text-gray-600 font-mono">
                            <span><i class="fas fa-heart mr-1"></i> <span id="feed-thread-likes-${data.id}">${data.likes || 0}</span></span>
                            <span><i class="fas fa-comment-alt mr-1"></i> ${data.commentCount || 0}</span>
                        </div>
                    `;
                } else {
                    el.className = 'story-card bg-black/40 rounded-xl overflow-hidden cursor-pointer relative group';
                    el.onclick = () => reader.open(data.id, data);
                    el.innerHTML = `
                        <div class="h-56 bg-cover bg-center grayscale group-hover:grayscale-0 transition-all duration-500" style="background-image: url('${data.coverImage}')">
                            <div class="w-full h-full bg-black/30 group-hover:bg-transparent transition-all duration-500"></div>
                        </div>
                        <div class="p-5 border-t border-white/5 relative bg-[#0c0c0c]">
                            <div class="absolute -top-3 right-4 bg-red-900 text-white text-[10px] font-bold px-2 py-1 rounded shadow-lg uppercase tracking-widest">
                                ${data.category || 'Unknown'}
                            </div>
                            <h3 class="font-bold text-lg text-gray-100 mb-2 truncate font-story group-hover:text-red-500 transition-colors">${data.title}</h3>
                            <p class="text-xs text-gray-500 line-clamp-2 mb-4 leading-relaxed">${data.description}</p>
                            <div class="flex justify-between items-center text-xs text-gray-600 border-t border-white/5 pt-3">
                                <span class="flex items-center gap-1"><img src="${author.avatar}" class="w-4 h-4 rounded-full"> ${formattedAuthorName}${verifiedBadge}</span>
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-heart ${likeIconClass}" id="feed-story-like-icon-${data.id}"></i> 
                                    <span id="feed-story-likes-${data.id}">${data.likes || 0}</span>
                                </span>
                            </div>
                        </div>
                    `;
                }
                return el;
            },
            createUserCard: (userData) => {
                const el = document.createElement('div');
                el.className = 'glass p-6 rounded-xl flex flex-col items-center text-center cursor-pointer hover:border-red-900 transition-colors';
                el.onclick = () => profile.open(userData.id);
                el.innerHTML = `
                    <img src="${userData.avatar}" class="w-20 h-20 rounded-full mb-4 border-2 border-gray-700">
                    <h4 class="font-bold text-lg text-white font-story">${formatUsername(userData.id, userData.username)}</h4>
                    <span class="text-xs text-red-500 uppercase tracking-widest">${getRank(userData.credits)}</span>
                    <p class="text-xs text-gray-500 mt-3 line-clamp-2">${userData.bio || 'Staring into the abyss...'}</p>
                    <div class="flex items-center gap-2 text-xs text-gray-600 font-mono mt-3">
                        <i class="fas fa-users"></i> ${userData.followerCount || 0} Followers
                    </div>
                `;
                return el;
            },
            loadUserSuggestions: async () => { 
                const container = document.getElementById('user-suggestions-container');
                const scroller = document.getElementById('user-suggestions-scroller');
                const grid = document.getElementById('user-suggestions-grid');
                const cloneGrid = document.getElementById('user-suggestions-grid-clone');
                grid.innerHTML = ''; cloneGrid.innerHTML = '';

                const myFollowing = state.profile.following || [];
                const usersToExclude = [state.user.uid, ...myFollowing];

                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users'), orderBy('followerCount', 'desc'), limit(20));
                const snap = await getDocs(q);

                let suggestions = [];
                snap.forEach(doc => {
                    if (!usersToExclude.includes(doc.id)) {
                        suggestions.push({ id: doc.id, ...doc.data() });
                    }
                });

                suggestions = suggestions.slice(0, 10);

                if (suggestions.length === 0) { container.classList.add('hidden'); return; }
                container.classList.remove('hidden');

                const createSuggestionCard = (u) => {
                    const el = document.createElement('div');
                    el.className = 'flex-shrink-0 w-40 glass p-4 rounded-lg flex flex-col items-center text-center';
                    el.innerHTML = `
                        <img src="${u.avatar}" class="w-16 h-16 rounded-full mb-3 border-2 border-gray-800 cursor-pointer" onclick="profile.open('${u.id}')">
                        <h5 class="font-bold text-sm text-white truncate w-full cursor-pointer" onclick="profile.open('${u.id}')">${formatUsername(u.id, u.username)}</h5>
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider mb-3">${getRank(u.credits)}</div>
                        <button id="suggest-follow-${u.id}" onclick="profile.toggleFollow('${u.id}', true)" class="btn-secondary py-1 px-4 text-xs w-full">Follow</button>
                    `;
                    return el;
                };

                suggestions.forEach(u => {
                    grid.appendChild(createSuggestionCard(u));
                    cloneGrid.appendChild(createSuggestionCard(u));
                });

                if (suggestions.length >= 7) {
                    scroller.classList.add('scrolling-enabled');
                    cloneGrid.classList.remove('hidden');
                } else {
                    scroller.classList.remove('scrolling-enabled');
                    cloneGrid.classList.add('hidden');
                }
            },
            loadSponsors: () => {
                const container = document.getElementById('sponsored-covens-container');
                const grid = document.getElementById('sponsored-covens-grid');
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities'), where('sponsoredUntil', '>', new Date()), orderBy('sponsoredUntil', 'desc'));
                
                onSnapshot(q, snap => {
                    if (snap.empty) {
                        container.classList.add('hidden');
                        return;
                    }
                    container.classList.remove('hidden');
                    grid.innerHTML = '';
                    snap.forEach(d => {
                        const c = d.data();
                        const el = document.createElement('div');
                        el.className = 'glass p-0 rounded-lg overflow-hidden cursor-pointer hover:border-yellow-700 border border-yellow-900/40 transition-colors group';
                        el.onclick = () => communities.open(d.id, c);
                        el.innerHTML = `
                            <div class="h-24 bg-cover bg-center" style="background-image: url('${c.coverImage}')"></div>
                            <div class="p-4">
                                <h3 class="font-bold text-yellow-400 text-sm mb-1 truncate">${c.name}</h3>
                                <p class="text-[11px] text-gray-500 line-clamp-2">${c.description}</p>
                            </div>
                        `;
                        grid.appendChild(el);
                    });
                });
            }
        };

        // --- NOTIFICATIONS ---
        window.notifications = { 
            init: () => {
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid, 'notifications'), orderBy('createdAt', 'desc'), limit(10));
                onSnapshot(q, (snap) => {
                    const list = document.getElementById('notif-list');
                    const badge = document.getElementById('notif-badge');
                    const empty = document.getElementById('notif-empty');
                    
                    list.innerHTML = '';
                    let unreadCount = 0;
                    
                    if(snap.empty) {
                        empty.classList.remove('hidden');
                        badge.classList.add('hidden');
                        return;
                    }
                    empty.classList.add('hidden');

                    snap.forEach(d => {
                        const n = d.data();
                        if(!n.read) unreadCount++;
                        let icon = 'fa-bell';
                        let color = 'text-gray-400';
                        if(n.type === 'credit') { icon = 'fa-coins'; color = 'text-yellow-500'; }
                        if(n.type === 'suggestion') { icon = 'fa-code-branch'; color = 'text-blue-500'; }
                        if(n.type === 'follow') { icon = 'fa-user-plus'; color = 'text-purple-500'; }
                        if(n.type === 'coven_role') { icon = 'fa-chess-king'; color = 'text-red-500'; }

                        const el = document.createElement('div');
                        el.className = `p-3 border-b border-white/5 hover:bg-white/5 cursor-pointer ${!n.read ? 'bg-red-900/10' : ''} flex justify-between items-start`;
                        el.innerHTML = `
                            <div class="flex gap-3 items-start flex-1">
                                <i class="fas ${icon} ${color} mt-1"></i>
                                <div>
                                    <div class="text-sm text-gray-300">${n.message}</div>
                                    <div class="text-[10px] text-gray-600 mt-1">${n.createdAt ? timeAgo(n.createdAt) : 'Just now'}</div>
                                </div>
                            </div>
                            <button class="text-gray-600 hover:text-red-500" title="Delete"><i class="fas fa-times"></i></button>
                        `;
                        
                        el.onclick = async (e) => {
                            if(e.target.closest('.fa-times') || e.target.closest('button')) {
                                await deleteDoc(d.ref); 
                                return;
                            }
                            if(!n.read) updateDoc(d.ref, { read: true });
                            if(n.type === 'suggestion' && n.payload) suggestions.openReview(n.payload.suggestionId, d.id);
                        };
                        list.appendChild(el);
                    });
                    if(unreadCount > 0) badge.classList.remove('hidden');
                    else badge.classList.add('hidden');
                });
            },
            toggle: () => {
                document.getElementById('notif-dropdown').classList.toggle('hidden');
            },
            send: async (targetUid, msg, type, payload = {}) => {
                await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'users', targetUid, 'notifications'), {
                    message: msg, type, createdAt: serverTimestamp(), read: false, payload
                });
            },
            clearAll: async () => {
                 ui.loading(true);
                 try {
                    const q = query(collection(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid, 'notifications'));
                    const snap = await getDocs(q);
                    const batch = writeBatch(db);
                    snap.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                 } catch (e) { ui.alert("Error", e.message); } finally { ui.loading(false); }
            }
        };

        // --- REWARDS ---
        window.rewards = { 
            claim: async () => {
                if(!state.profile) return;
                const now = new Date();
                const last = state.profile.lastDaily ? state.profile.lastDaily.toDate() : new Date(0);
                const diff = now - last;
                const hours = diff / (1000 * 60 * 60);

                if(hours >= 24) {
                    ui.loading(true);
                    try {
                        await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid), {
                            credits: increment(50),
                            lastDaily: serverTimestamp()
                        });
                        ui.alert("Fortune", "The Void grants you 50 credits.");
                        ui.loading(false);
                    } catch(e) { ui.loading(false); ui.alert("Error", e.message); }
                } else {
                    const wait = Math.ceil(24 - hours);
                    ui.alert("Greed", `Wait ${wait} more hours, mortal.`);
                }
            }
        };

        // --- PROFILE SYSTEM ---
        window.profile = {
            save: async () => { 
                const newName = document.getElementById('edit-username').value.trim();
                const newBio = document.getElementById('edit-bio').value.trim();
                const newLink = document.getElementById('edit-link').value.trim();
                
                // Check if changes were made
                const isNameSame = newName === state.profile.username;
                const isBioSame = newBio === (state.profile.bio || '');
                const isLinkSame = newLink === (state.profile.link || '');
                const isAvatarSame = !state.profileEditAvatarBlob;

                if (isNameSame && isBioSame && isLinkSame && isAvatarSame) {
                    return ui.alert("Stagnation", "No changes were made to your identity.");
                }

                // If name changed, check availability again to be safe
                if (!isNameSame) {
                    const check = await checkUsername(newName);
                    if (!check.valid) return ui.alert("Invalid Name", check.message);
                }

                ui.loading(true);

                let avatarUrl = state.profile.avatar;
                if (state.profileEditAvatarBlob) {
                     const uploadedUrl = await creator.upload(state.profileEditAvatarBlob);
                     if (uploadedUrl) avatarUrl = uploadedUrl;
                }

                await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid), {
                    username: newName, bio: newBio, link: newLink, avatar: avatarUrl
                });
                
                // Update Firebase Auth profile display name too
                if (!isNameSame) {
                     await updateProfile(authService.currentUser, { displayName: newName });
                }

                state.profileEditAvatarBlob = null;
                ui.closeProfileEditor();
                ui.alert("Identity", "Your mask has been adjusted.");
                ui.loading(false);
            },
            viewSelf: () => profile.open(state.user.uid),
            openFromReader: () => {
                if(state.activeStory) profile.open(state.activeStory.authorId);
            },
            open: async (uid, push = true) => {
                ui.loading(true);
                state.activeProfileId = uid;
                const isSelf = uid === state.user.uid;

                const p = await getUserProfile(uid);
                if(!p) { ui.loading(false); return ui.alert("Lost", "Soul not found."); }

                const isVerified = (p.followerCount || 0) >= 100;
                const verifiedBadge = isVerified ? ` <span class="text-red-600" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';
                
                // Use formatUsername for profile title
                document.getElementById('profile-view-name').innerHTML = formatUsername(uid, p.username) + verifiedBadge;
                document.getElementById('profile-view-bio').innerText = p.bio || "Staring into the abyss...";
                document.getElementById('profile-view-img').src = p.avatar;
                document.getElementById('profile-view-followers').innerText = abbreviateNumber((p.followers || []).length);
                document.getElementById('profile-view-following').innerText = abbreviateNumber((p.following || []).length);
                document.getElementById('profile-rank').innerText = getRank(p.credits || 0);
                
                const joinedEl = document.getElementById('profile-view-joined');
                if (p.joined) {
                    joinedEl.innerHTML = `<i class="fas fa-clock mr-1"></i> Joined ${timeAgo(p.joined)}`;
                    joinedEl.classList.remove('hidden');
                } else {
                    joinedEl.classList.add('hidden');
                }

                const rankEl = document.getElementById('profile-leaderboard-rank');
                if(state.leaderboard) {
                    const idx = state.leaderboard.findIndex(u => u.id === uid);
                    if(idx !== -1) {
                        rankEl.innerText = `#${idx + 1}`;
                        rankEl.classList.remove('hidden');
                    } else {
                        rankEl.classList.add('hidden');
                    }
                }

                const badgesContainer = document.getElementById('profile-badges');
                badgesContainer.innerHTML = '';
                
                // Creator Badge Check
                if(uid === CREATOR_ID) {
                     badgesContainer.innerHTML += `<span title="The Architect: Creator of Grimoire" class="text-red-600 animate-pulse"><i class="fas fa-code"></i></span>`;
                }
                
                if ((p.covenCreatedCount || 0) > 0) badgesContainer.innerHTML += `<span title="Genesis Coven: Founded a Coven"><i class="fas fa-crown"></i></span>`;
                if ((p.postCount || 0) >= 10) badgesContainer.innerHTML += `<span title="Prolific Scribe: Published 10+ stories"><i class="fas fa-feather-alt"></i></span>`;
                if ((p.totalTipped || 0) >= 1000) badgesContainer.innerHTML += `<span title="Patron of Horrors: Tipped over 1000 CR"><i class="fas fa-hand-holding-heart"></i></span>`;

                const linkContainer = document.getElementById('profile-links');
                linkContainer.innerHTML = p.link ? `<a href="${p.link}" target="_blank" class="hover:text-white"><i class="fas fa-link mr-1"></i> ${new URL(p.link).hostname}</a>` : '';

                const followBtn = document.getElementById('btn-follow');
                const editBtn = document.getElementById('btn-edit-profile');
                document.getElementById('profile-img-edit-overlay').style.display = isSelf ? 'flex' : 'none';
                if(isSelf) {
                    followBtn.classList.add('hidden');
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                    followBtn.classList.remove('hidden');
                    const isFollowing = (state.profile.following || []).includes(uid);
                    followBtn.innerText = isFollowing ? "Unfollow" : "Follow";
                }

                profile.switchTab('artifacts');

                if(push) router.go('profile', { user: uid });
                else router.render('profile', { user: uid });
                ui.loading(false);
            },
            toggleFollow: async (targetUid = null, fromSuggestion = false) => {
                const idToToggle = targetUid || state.activeProfileId;
                if (!idToToggle || idToToggle === state.user.uid || state.followLock) return;
                
                state.followLock = true;
                const isCurrentlyFollowing = (state.profile.following || []).includes(idToToggle);

                const mainProfileButton = document.getElementById('btn-follow');
                const suggestionButton = fromSuggestion ? document.getElementById(`suggest-follow-${idToToggle}`) : null;

                if (mainProfileButton && !fromSuggestion) mainProfileButton.disabled = true;
                if (suggestionButton) suggestionButton.disabled = true;

                const targetUserRef = doc(db, 'artifacts', APP_ID_PATH, 'users', idToToggle);
                const currentUserRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);

                try {
                    const batch = writeBatch(db);
                    if (isCurrentlyFollowing) {
                        batch.update(targetUserRef, { followers: arrayRemove(state.user.uid), followerCount: increment(-1) });
                        batch.update(currentUserRef, { following: arrayRemove(idToToggle) });
                    } else {
                        batch.update(targetUserRef, { followers: arrayUnion(state.user.uid), followerCount: increment(1) });
                        batch.update(currentUserRef, { following: arrayUnion(idToToggle) });
                        notifications.send(idToToggle, `${state.profile.username} followed you.`, 'follow');
                    }
                    await batch.commit();

                    state.userCache[idToToggle] = null;
                    state.userCache[state.user.uid] = null;
                    
                    const updatedProfileSnap = await getDoc(currentUserRef);
                    if(updatedProfileSnap.exists()) {
                        state.profile = updatedProfileSnap.data();
                    }
                    
                    if (!fromSuggestion && state.activeProfileId === idToToggle) {
                        profile.open(idToToggle, false);
                    } else {
                        if (mainProfileButton && !fromSuggestion) mainProfileButton.innerText = isCurrentlyFollowing ? "Follow" : "Unfollow";
                        if (suggestionButton) suggestionButton.innerText = isCurrentlyFollowing ? "Follow" : "Unfollow";
                    }

                } catch (error) {
                    console.error("Follow/Unfollow Error:", error);
                     ui.alert("Error", "Could not complete action. Please try again.");
                } finally {
                    if (mainProfileButton && !fromSuggestion) mainProfileButton.disabled = false;
                    if (suggestionButton) suggestionButton.disabled = false;
                    state.followLock = false;
                }
            },
            showFollowList: async (type) => { 
                if(!state.activeProfileId) return;
                const modal = document.getElementById('modal-follow-list');
                const titleEl = document.getElementById('follow-list-title');
                const contentEl = document.getElementById('follow-list-content');
                titleEl.innerText = type === 'followers' ? 'Followers' : 'Following';
                contentEl.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"><i class="fas fa-spinner fa-spin"></i></div>';
                ui.openModal('modal-follow-list');

                const profileSnap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', state.activeProfileId));
                if (!profileSnap.exists()) return;
                
                const idList = profileSnap.data()[type] || [];
                if (idList.length === 0) {
                    contentEl.innerHTML = `<div class="text-center text-gray-600 text-xs py-4 italic">No souls found.</div>`;
                    return;
                }

                const userPromises = idList.map(uid => getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', uid)));
                const userSnaps = await Promise.all(userPromises);

                contentEl.innerHTML = '';
                userSnaps.forEach(snap => {
                    if (snap.exists()) {
                        const user = snap.data();
                        const el = document.createElement('div');
                        el.className = 'flex items-center justify-between p-2 rounded';
                        el.innerHTML = `
                            <div class="flex items-center gap-3 cursor-pointer" onclick="ui.closeModal('modal-follow-list'); profile.open('${snap.id}')">
                                <img src="${user.avatar}" class="w-8 h-8 rounded-full object-cover border border-gray-700">
                                <span class="font-bold text-sm text-gray-300">${formatUsername(snap.id, user.username)}</span>
                            </div>
                        `;
                        contentEl.appendChild(el);
                    }
                });
            },
            switchTab: (tabName) => {
                document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                document.getElementById(`tab-${tabName}`).classList.add('active');
                
                const container = document.getElementById('profile-content-area');
                container.innerHTML = ''; 
                
                if (tabName === 'artifacts') profile.loadArtifacts(container);
                else if (tabName === 'allies') profile.loadAllies(container);
                else if (tabName === 'covens') profile.loadCovens(container);
            },
            loadArtifacts: (container) => {
                container.innerHTML = `<div id="profile-posts-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>`;
                const grid = document.getElementById('profile-posts-grid');
                
                const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories'), where('authorId', '==', state.activeProfileId), limit(50));
                
                onSnapshot(q, (snap) => {
                     let totalLikes = 0;
                     if(snap.empty) {
                        grid.innerHTML = `<div class="col-span-3 text-center text-gray-600 py-16">
                            <i class="fas fa-dungeon text-5xl mb-4"></i>
                            <h3 class="font-bold text-lg text-gray-400">The Vault is Empty</h3>
                            <p class="text-sm">This soul has yet to manifest any artifacts.</p>
                        </div>`;
                        document.getElementById('profile-view-likes').innerText = '0';
                        return;
                     }

                     let posts = [];
                     snap.forEach(d => {
                         const data = d.data();
                         totalLikes += (data.likes || 0);
                         posts.push({ id: d.id, ...data });
                     });
                     
                     posts.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                     grid.innerHTML = '';
                     posts.forEach(data => {
                         const el = document.createElement('div');
                         el.className = 'glass p-4 rounded cursor-pointer hover:bg-white/5 transition-colors border border-transparent hover:border-red-900';
                         el.onclick = () => reader.open(data.id, data);
                         el.innerHTML = `
                             <div class="font-bold text-gray-300 truncate mb-1">${data.title}</div>
                             <div class="flex justify-between items-center text-xs">
                                <span class="text-red-500 uppercase font-bold">${data.category}</span>
                                <span class="text-gray-600"><i class="fas fa-heart mr-1"></i> ${data.likes || 0}</span>
                             </div>
                         `;
                         grid.appendChild(el);
                     });
                     
                     document.getElementById('profile-view-likes').innerText = abbreviateNumber(totalLikes);
                }, (error) => {
                    console.error("Error loading artifacts:", error);
                    grid.innerHTML = `<div class="col-span-3 text-center text-red-500 py-16">Failed to load artifacts. The void is disturbed.</div>`;
                });
            },
            loadAllies: async (container) => {
                const profileSnap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', state.activeProfileId));
                const followingIds = profileSnap.data().following || [];
                
                if (followingIds.length === 0) {
                    container.innerHTML = `<div class="col-span-full text-center text-gray-600 py-16">
                        <i class="fas fa-street-view text-5xl mb-4"></i>
                        <h3 class="font-bold text-lg text-gray-400">A Solitary Path</h3>
                        <p class="text-sm">This soul walks the void alone, for now.</p>
                    </div>`;
                    return;
                }
                
                container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="allies-grid"></div>';
                const grid = document.getElementById('allies-grid');
                
                const promises = followingIds.map(id => getDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', id)));
                const results = await Promise.all(promises);
                
                results.forEach(snap => {
                    if(snap.exists()) {
                        const u = snap.data();
                        const el = document.createElement('div');
                        el.className = 'glass p-3 rounded flex items-center gap-3 cursor-pointer hover:bg-white/5';
                        el.onclick = () => profile.open(snap.id);
                        el.innerHTML = `
                            <img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-700">
                            <div>
                                <div class="font-bold text-gray-300 text-sm">${formatUsername(snap.id, u.username)}</div>
                                <div class="text-[10px] text-gray-500">${getRank(u.credits)}</div>
                            </div>
                        `;
                        grid.appendChild(el);
                    }
                });
            },
            loadCovens: async (container) => {
                 const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities'), where('members', 'array-contains', state.activeProfileId), limit(20));
                 const snap = await getDocs(q);
                 
                 if(snap.empty) {
                     container.innerHTML = `<div class="col-span-full text-center text-gray-600 py-16">
                        <i class="fas fa-monument text-5xl mb-4"></i>
                        <h3 class="font-bold text-lg text-gray-400">Unaligned</h3>
                        <p class="text-sm">This soul has not pledged allegiance to any coven.</p>
                    </div>`;
                     return;
                 }
                 
                 container.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="covens-grid"></div>';
                 const grid = document.getElementById('covens-grid');
                 
                 snap.forEach(d => {
                     const c = d.data();
                     const el = document.createElement('div');
                     el.className = 'glass p-0 rounded-lg overflow-hidden cursor-pointer hover:border-red-900 transition-colors group';
                     el.onclick = () => communities.open(d.id, c);
                     el.innerHTML = `
                         <div class="h-16 bg-cover bg-center grayscale group-hover:grayscale-0 transition-all" style="background-image: url('${c.coverImage}')"></div>
                         <div class="p-3">
                             <h4 class="font-bold text-red-400 text-sm mb-1">${c.name}</h4>
                             <div class="text-[10px] text-gray-600 font-mono"><i class="fas fa-users mr-1"></i> ${c.memberCount}</div>
                         </div>
                     `;
                     grid.appendChild(el);
                 });
            }
        };

        // --- READER ---
        window.reader = { 
            open: async (id, data, push = true) => {
                state.activeStory = { id, ...data };
                if(data.type === 'thread') { threadView.open(id, data); return; }

                const readerBody = document.getElementById('reader-body');
                const deniedBody = document.getElementById('reader-access-denied');
                if (data.membersOnly && data.communityId) {
                    const covenSnap = await getDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'communities', data.communityId));
                    if(covenSnap.exists()){
                        state.activeCommunity = {id: covenSnap.id, ...covenSnap.data()}; 
                        if (!communities.isMember()) {
                            readerBody.classList.add('hidden');
                            deniedBody.classList.remove('hidden');
                        } else {
                            readerBody.classList.remove('hidden');
                            deniedBody.classList.add('hidden');
                        }
                    }
                } else {
                    readerBody.classList.remove('hidden');
                    deniedBody.classList.add('hidden');
                }


                const author = await getUserProfile(data.authorId);
                if (!author) return;

                document.getElementById('reader-title').innerText = data.title;
                document.getElementById('reader-cover').src = data.coverImage;
                readerBody.innerHTML = data.content;
                
                const isVerified = (author.followerCount || 0) >= 100;
                const verifiedBadge = isVerified ? ` <span class="text-red-600" title="Verified Soul"><i class="fas fa-check-circle"></i></span>` : '';
                document.getElementById('reader-author').innerHTML = formatUsername(author.id, author.username) + verifiedBadge;

                document.getElementById('reader-avatar').src = author.avatar;
                document.getElementById('reader-cat-tag').innerText = data.category;
                
                const hasLiked = (state.profile.likedStories || []).includes(state.activeStory.id);
                const icon = document.getElementById('like-icon');
                if(hasLiked) icon.classList.add('text-red-600'); else icon.classList.remove('text-red-600');
                document.getElementById('reader-likes').innerText = data.likes || 0;

                const isOwner = state.user.uid === data.authorId;
                const editBtn = document.getElementById('btn-reader-edit');
                const suggestBtn = document.getElementById('btn-reader-suggest');
                
                if (isOwner) {
                    editBtn.classList.remove('hidden');
                    suggestBtn.classList.add('hidden'); // Hide suggest edit for owner
                } else {
                    editBtn.classList.add('hidden');
                    suggestBtn.classList.remove('hidden');
                }

                loadComments(id);
                if(push) router.go('reader', { post: id }); else router.render('reader', { post: id });
            },
            toggleLike: async (storyId = null) => {
                const id = storyId || state.activeStory.id;
                if (state.isLiking || !id) return;
                state.isLiking = true;

                const hasLiked = (state.profile.likedStories || []).includes(id);

                if (!hasLiked) {
                    const storyRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', id);
                    const storySnap = await getDoc(storyRef);
                    if (storySnap.exists()) {
                        const storyData = storySnap.data();
                        const newLikes = (storyData.likes || 0) + 1;
                        const milestones = storyData.milestonesReached || [];
                        let reward = 0;
                        let milestoneMsg = '';

                        if (newLikes === 10 && !milestones.includes('10_likes')) {
                            reward = 10;
                            milestones.push('10_likes');
                            milestoneMsg = `Your story "${storyData.title}" reached 10 likes! +${reward} CR`;
                        } else if (newLikes === 50 && !milestones.includes('50_likes')) {
                            reward = 50;
                            milestones.push('50_likes');
                            milestoneMsg = `Your story "${storyData.title}" reached 50 likes! +${reward} CR`;
                        } else if (newLikes === 100 && !milestones.includes('100_likes')) {
                             reward = 100;
                            milestones.push('100_likes');
                            milestoneMsg = `Your story "${storyData.title}" reached 100 likes! +${reward} CR`;
                        }

                        if (reward > 0) {
                            await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'users', storyData.authorId), { credits: increment(reward) });
                            await updateDoc(storyRef, { milestonesReached: milestones });
                            notifications.send(storyData.authorId, milestoneMsg, 'credit');
                        }
                    }
                }

                 if (state.activeStory && state.activeStory.id === id) {
                    const readerLikeIcon = document.getElementById('like-icon');
                    const readerLikesCount = document.getElementById('reader-likes');
                    if (readerLikeIcon && readerLikesCount) {
                        if (hasLiked) {
                            readerLikeIcon.classList.remove('text-red-600');
                            readerLikesCount.innerText = parseInt(readerLikesCount.innerText) - 1;
                        } else {
                            readerLikeIcon.classList.add('text-red-600');
                            readerLikesCount.innerText = parseInt(readerLikesCount.innerText) + 1;
                        }
                    }
                }

                try {
                    const storyRef = doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', id);
                    const userRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);

                    if (hasLiked) {
                        await updateDoc(storyRef, { likes: increment(-1), likedBy: arrayRemove(state.user.uid) });
                        await updateDoc(userRef, { likedStories: arrayRemove(id) });
                    } else {
                        const batch = writeBatch(db);
                        batch.update(storyRef, { likes: increment(1), likedBy: arrayUnion(state.user.uid) });
                        batch.update(userRef, { likedStories: arrayUnion(id) });
                        await batch.commit();
                    }
                    const profileSnap = await getDoc(userRef);
                    if (profileSnap.exists()) state.profile = { ...state.profile, ...profileSnap.data() };
                } catch (e) { console.error("Like error", e); } finally { state.isLiking = false; }
            },
            share: (storyId = null) => {
                const id = storyId || state.activeStory.id;
                const url = `${window.location.origin}${window.location.pathname}?post=${id}`;
                navigator.clipboard.writeText(url).then(() => ui.alert("Copied", "Link copied to clipboard."));
            },
            reportOpen: () => ui.openModal('modal-report'),
            submitReport: async (reason) => {
                 await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'reports'), {
                     storyId: state.activeStory.id, reporter: state.user.uid, reason, createdAt: serverTimestamp()
                 });
                 ui.closeModal('modal-report');
                 ui.alert("Reported", "The Council has been notified.");
            },
            creshare: (amt) => reader.processTip(amt),
            creshareCustom: () => {
                const val = parseInt(document.getElementById('reader-tip-input').value);
                if(val > 0) reader.processTip(val);
            },
            processTip: async (amt) => {
                if(state.profile.credits < amt) return ui.alert("Poor Soul", "Insufficient credits. Your coffers are empty.");
                if(state.activeStory.authorId === state.user.uid) return ui.alert("Vanity", "Cannot tip yourself.");
                ui.loading(true);
                try {
                    const tipperRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.user.uid);
                    const authorRef = doc(db, 'artifacts', APP_ID_PATH, 'users', state.activeStory.authorId);
                    
                    await updateDoc(tipperRef, { 
                        credits: increment(-amt),
                        totalTipped: increment(amt) 
                    });
                    await updateDoc(authorRef, { credits: increment(amt) });
                    
                    notifications.send(state.activeStory.authorId, `Received ${amt} credits from ${state.profile.username}`, 'credit');
                    ui.loading(false);
                    ui.alert("Generosity", `You have transferred ${amt} credits.`);
                } catch(e) { ui.loading(false); ui.alert("Error", e.message); }
            },
            postComment: async () => {
                const txt = document.getElementById('comment-input').value;
                if(!txt) return;
                await addDoc(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.activeStory.id, 'comments'), {
                    text: txt, author: state.profile.username, authorId: state.user.uid, createdAt: serverTimestamp()
                });
                await updateDoc(doc(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', state.activeStory.id), {
                    commentCount: increment(1)
                });
                document.getElementById('comment-input').value = '';
            },
            startEdit: () => {
                creator.reset();
                state.draft.isEdit = true;
                state.draft.targetStoryId = state.activeStory.id;
                state.draft.cover = state.activeStory.coverImage;
                state.draft.category = state.activeStory.category;
                
                document.getElementById('create-title').value = state.activeStory.title;
                document.getElementById('create-desc').value = state.activeStory.description;
                document.getElementById('editor-content').innerHTML = state.activeStory.content;
                document.getElementById('create-tags').value = (state.activeStory.tags || []).join(', ');
                
                const coverPreview = document.getElementById('cover-preview');
                if (state.activeStory.coverImage && state.activeStory.coverImage !== 'https://via.placeholder.com/800x400/000?text=Void') {
                    coverPreview.src = state.activeStory.coverImage;
                    coverPreview.classList.remove('hidden');
                }
                
                ui.selectOption('cat', state.activeStory.category || "Select Realm");
                
                document.getElementById('create-header-title').innerText = "Rewrite History";
                document.getElementById('create-header-sub').innerText = "You are editing your artifact.";
                document.getElementById('btn-publish').classList.add('hidden');
                document.getElementById('btn-suggest').classList.add('hidden');
                document.getElementById('btn-update-story').classList.remove('hidden');
                
                router.go('create');
            },
            startSuggestion: () => {
                if(state.activeStory.authorId === state.user.uid) return reader.startEdit();
                creator.reset();
                state.draft.isSuggestion = true;
                state.draft.targetStoryId = state.activeStory.id;
                
                document.getElementById('create-title').value = state.activeStory.title;
                document.getElementById('create-desc').value = state.activeStory.description;
                document.getElementById('editor-content').innerHTML = state.activeStory.content;
                
                document.getElementById('create-title').disabled = true;
                document.getElementById('create-desc').disabled = true;
                document.getElementById('create-tags').value = (state.activeStory.tags || []).join(', ');
                document.getElementById('create-tags').disabled = true;
                document.getElementById('cat-dropdown').style.pointerEvents = 'none';
                document.getElementById('cover-upload-container').style.pointerEvents = 'none';

                const coverPreview = document.getElementById('cover-preview');
                 if (state.activeStory.coverImage && state.activeStory.coverImage !== 'https://via.placeholder.com/800x400/000?text=Void') {
                    coverPreview.src = state.activeStory.coverImage;
                    coverPreview.classList.remove('hidden');
                }
                ui.selectOption('cat', state.activeStory.category || "Select Realm");


                document.getElementById('create-header-title').innerText = "Suggest Edits";
                document.getElementById('create-header-sub').innerText = "Your changes will be submitted for review.";
                document.getElementById('btn-publish').classList.add('hidden');
                document.getElementById('btn-suggest').classList.remove('hidden');
                document.getElementById('btn-update-story').classList.add('hidden');

                router.go('create');
            }
        };

        // --- DATA ---
        function loadFeed() { 
            const container = document.getElementById('feed-grid');
            const emptyEl = document.getElementById('feed-empty');
            container.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Summoning...</div>';
            emptyEl.classList.add('hidden');
            container.classList.remove('hidden');

            let q;
            const ref = collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories');
            
            if(state.sortBy === 'following') {
                if (state.profile.following && state.profile.following.length > 0) {
                     q = query(ref, where('authorId', 'in', state.profile.following), limit(50));
                } else {
                    feed.render([]); return;
                }
            }
            else if(state.filter) {
                 q = query(ref, where("category", "==", state.filter), limit(50));
            }
            else if(state.sortBy === 'hot') {
                q = query(ref, orderBy('likes', 'desc'), limit(50));
            }
            else {
                q = query(ref, orderBy('createdAt', 'desc'), limit(50));
            }

            onSnapshot(q, async (snap) => {
                 if (document.getElementById('feed-search').value.trim() !== '') return;
                const stories = [];
                snap.forEach(d => {
                    const data = {id: d.id, ...d.data()};
                    if(!data.communityId) stories.push(data); 
                });
                
                if (state.filter || state.sortBy === 'following') {
                    stories.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                }
                
                const authorIds = [...new Set(stories.map(s => s.authorId))];
                await Promise.all(authorIds.map(id => getUserProfile(id)));

                state.feedData = stories;
                feed.render(state.feedData);
            });
        }
        
        async function searchUsersAndContent(term) { 
            const lowerTerm = normalize(term);
            const results = [];
            
            const contentGrid = document.getElementById('feed-grid');
            contentGrid.innerHTML = '<div class="col-span-3 text-center py-10 text-gray-500"><i class="fas fa-spinner fa-spin"></i> Scouring the archives...</div>';

            try {
                const userQuery = query(collection(db, 'artifacts', APP_ID_PATH, 'users'), limit(50));
                const userSnap = await getDocs(userQuery);
                userSnap.forEach(doc => {
                     const u = doc.data();
                     if(normalize(u.username).includes(lowerTerm) || normalize(u.bio).includes(lowerTerm)){
                        results.push({ type: 'user-profile', data: { id: doc.id, ...u } });
                     }
                });

                const contentQuery = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories'), limit(100));
                const contentSnap = await getDocs(contentQuery);
                
                contentSnap.forEach(doc => {
                    const d = doc.data();
                    if (d.communityId) return; 
                    
                    const titleMatch = normalize(d.title).includes(lowerTerm);
                    const descMatch = normalize(d.description).includes(lowerTerm);
                    const tagMatch = (d.tags || []).some(t => normalize(t).includes(lowerTerm));
                    
                    if (titleMatch || descMatch || tagMatch) {
                        results.push({id: doc.id, ...d});
                    }
                });

                const authorIds = [...new Set(results.filter(r => r.type !== 'user-profile').map(s => s.authorId))];
                await Promise.all(authorIds.map(id => getUserProfile(id)));
                
                feed.render(results);
            } catch(e) {
                console.error(e);
                contentGrid.innerHTML = '<div class="col-span-3 text-center text-red-500">The void rejected your query.</div>';
            }
        }

        function loadComments(storyId) { 
            const list = document.getElementById('comments-list');
            list.innerHTML = ''; 
            const q = query(collection(db, 'artifacts', APP_ID_PATH, 'public', 'data', 'stories', storyId, 'comments'), orderBy('createdAt', 'desc'));
            onSnapshot(q, snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    document.getElementById('comments-empty').classList.remove('hidden');
                } else {
                    document.getElementById('comments-empty').classList.add('hidden');
                }
                snap.forEach(d => {
                    const c = d.data();
                    const commentTime = c.createdAt ? timeAgo(c.createdAt) : 'Just now';
                    list.innerHTML += `
                        <div class="bg-white/5 p-4 rounded border-l-2 border-red-900">
                            <div class="text-xs text-red-400 font-bold mb-1">${formatUsername(c.authorId, c.author)}  ${commentTime}</div>
                            <div class="text-sm text-gray-300 font-story break-words">${c.text}</div>
                        </div>
                    `;
                });
            });
        }

        // --- LISTENERS ---
        document.getElementById('editor-content').addEventListener('input', creator.recalc);
        
        document.getElementById('cover-input').addEventListener('change', async (e) => {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                ui.loading(true);
                const url = await creator.upload(file);
                if(url) { 
                    state.draft.cover = url; 
                    document.getElementById('cover-preview').src = url; 
                    document.getElementById('cover-preview').classList.remove('hidden'); 
                }
                ui.loading(false);
            }
        });

        document.getElementById('coven-img-upload').addEventListener('change', async (e) => {
            const url = await creator.upload(e.target.files[0]);
            if(url) { document.getElementById('coven-img-preview').src = url; document.getElementById('coven-img-preview').classList.remove('hidden'); }
        });

        document.getElementById('profile-img-upload').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    ui.initCropper(event.target.result, (blob) => {
                        state.profileEditAvatarBlob = blob;
                        document.getElementById('edit-profile-avatar').src = URL.createObjectURL(blob);
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
         document.getElementById('signup-avatar-input').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    ui.initCropper(event.target.result, (blob) => {
                        state.signupAvatarBlob = blob;
                        document.getElementById('signup-avatar-preview').src = URL.createObjectURL(blob);
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('inline-image-input').addEventListener('change', async (e) => {
            const url = await creator.upload(e.target.files[0]);
            if(url) {
                const editor = document.getElementById('editor-content');
                editor.focus(); 
                const imgHtml = `<img src="${url}" style="width: ${state.draft.imgScale}; margin: 10px auto; display: block;" /><br>`;
                if (!document.execCommand('insertHTML', false, imgHtml)) {
                    editor.innerHTML += imgHtml;
                }
                state.draft.images++; creator.recalc();
            }
        });
        
        // --- VALIDATION LISTENERS ---
        document.getElementById('signup-name').addEventListener('input', debounce(() => {
            handleUsernameInput('signup-name', 'signup-username-feedback');
        }, 500));

        document.getElementById('edit-username').addEventListener('input', debounce(() => {
            handleUsernameInput('edit-username', 'edit-username-feedback', state.profile.username);
        }, 500));
        
        function setupSearchClear(inputId, clearId, searchIconClass, onClear) {
            const input = document.getElementById(inputId);
            const clearBtn = document.getElementById(clearId);
            const searchIcon = input.parentElement.querySelector(searchIconClass);

            input.addEventListener('input', () => {
                const hasValue = input.value.trim().length > 0;
                clearBtn.classList.toggle('hidden', !hasValue);
                if (searchIcon) {
                    searchIcon.classList.toggle('hidden', hasValue);
                }
            });

            clearBtn.addEventListener('click', () => {
                input.value = '';
                clearBtn.classList.add('hidden');
                if (searchIcon) {
                    searchIcon.classList.remove('hidden');
                }
                onClear();
                input.focus();
            });
        }

        setupSearchClear('feed-search', 'feed-search-clear', '.fa-search', () => {
            document.getElementById('feed-title').innerText = "Chronicles";
            document.getElementById('feed-empty').classList.add('hidden');
            loadFeed();
        });

        setupSearchClear('explore-search', 'explore-search-clear', '.fa-search', () => {
            communities.loadAll();
        });

        let searchTimeout;
        document.getElementById('feed-search').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const term = e.target.value.trim();
            if(!term) { 
                document.getElementById('feed-title').innerText = "Chronicles";
                loadFeed(); 
                return; 
            }
            document.getElementById('feed-title').innerText = `Results for "${term}"`;
            searchTimeout = setTimeout(() => searchUsersAndContent(term), 500);
        });

        document.getElementById('explore-search').addEventListener('input', (e) => {
             clearTimeout(searchTimeout);
            const term = e.target.value.trim();
            if (!term) {
                communities.loadAll();
            } else {
                searchTimeout = setTimeout(() => explore.search(term), 500);
            }
        });


        // --- INIT ---
        onAuthStateChanged(authService, (user) => {
            if(user) {
                state.user = user;
                onSnapshot(doc(db, 'artifacts', APP_ID_PATH, 'users', user.uid), d => {
                    if(d.exists()) {
                        const profileData = d.data();
                        state.profile = profileData;
                        state.userCache[user.uid] = { id: user.uid, ...profileData };

                        const navUser = document.getElementById('nav-user');
                        if(navUser) navUser.innerText = state.profile.username;
                        document.getElementById('nav-credits').innerText = state.profile.credits;
                        document.getElementById('view-auth').classList.add('hidden');
                        document.getElementById('app-shell').classList.remove('hidden');
                        
                        notifications.init();
                        explore.loadTrending(); 
                        explore.loadFresh();

                        router.handlePopState();
                    }
                });
            } else {
                document.getElementById('app-shell').classList.add('hidden');
                document.getElementById('view-auth').classList.remove('hidden');
            }
            ui.loading(false);
        });

    </script>
</body>
</html>
